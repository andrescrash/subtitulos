<!DOCTYPE html>
<html>
 
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css?family=M+PLUS+1p" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css?family=Hachi+Maru+Pop" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Yusei+Magic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Reggae+One" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Sawarabi+Gothic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">

    <link href="./font.css" rel="stylesheet">

    <link rel="icon" href="./img/favicon2/favicon.ico" />
    <script src="js/bouyomichan_client.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5RNP0LDER8"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-5RNP0LDER8');
    </script>
    <!-- END: Google tag (gtag.js) -->

    <title>SubtÃ­tulos en Vivo</title>

    <style type="text/css">
        /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªbox-sizingãƒªã‚»ãƒƒãƒˆ */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        button, input, select, textarea {
            /* font-family : inherit; */
            /* font-family: 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo,sans-serif; */
            /* font-size   : 300%; */
            /* color  : black; */
            font-weight : 0;
            /*text-align  : center;       /* left, center, right */
            vertical-align : top;    /* top, middle, bottom */
            -webkit-text-stroke-color: rgb(21, 0, 141);
            -webkit-text-stroke-width: 0px;
        }

        html {
            height: 100%;
            width: 100%;
        }

        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: auto;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            /* font-family:'07NikumaruFont'; */
        }
        table {
            width: 100%;
            /* table-layout: fixed; */
        }
        table.btm_table {
            position:absolute;
            /* bottom:0; */
        }

        table td {
            /*word-break: break-all;*/
            overflow-wrap : break-word;
        }
    </style>

    <style>
        /* prepare the selectors to add a stroke to */

        .stroke-single-imb{
            /* position: absolute; */
            left: 0;
            right: 0;
            margin: 0;
            /* -webkit-text-stroke: 0px #0000FF;  */
        }

        .stroke-single-bg{
            position: absolute;
            left: 0;
            right: 0;
            margin: auto;
            /* -webkit-text-stroke: 3px #FF0000;  */
        }
        /* add a single stroke */
        .stroke-single-fg{
            position: absolute;
            left: 0;
            right: 0;
            margin: auto;
            /* -webkit-text-stroke: 0px #FFFFFF; */
        }
    </style>

</head>
 

<body>

<!-- # æ³¨æ„äº‹é … ######################### -->
<!-- <iframe src="" name="sample" width="100%" height="30%" id="asr_frame" onclick="toggleIframeHeight()"></iframe> -->
<iframe src="" name="sample" width="100%" height="30%" id="asr_frame" onclick="toggleIframeHeight()" style="border: none;"></iframe>

ã€€Haz clic en la pantalla superior para ocultar/mostrar la ventana de configuraciÃ³n.<BR>
<HR>

<!-- # Preajustesæ©Ÿèƒ½ã¨APIã‚­ãƒ¼ ################## -->
<div style="display: flex; gap: 10px; margin-bottom: 5px;">
    <!-- å·¦å´ï¼šPreajustes de configuraciÃ³n -->
    <div style="width: 280px; background-color: #ffe0e6; padding: 8px 10px; border-radius: 5px;">
        <div style="font-size: 14px; margin-bottom: 4px;">Preajustes de configuraciÃ³nï¼š</div>
        <select id="presetSelect" onchange="loadPreset()" style="width: 100%; margin-bottom: 4px;">
            <option value="default">ğŸ“‹ Selecciona</option>
            <option value="gaming">ğŸ® Para transmisiÃ³n de juegos</option>
            <option value="meeting">ğŸ’¼ Para reuniones y consultas</option>
            <option value="language_learning">ğŸ“š Para aprendizaje de idiomas</option>
            <option value="accessibility">â™¿ Enfocado en accesibilidad</option>
            <option value="cute_streaming">ğŸŒ¸ Para transmisiones lindas</option>
            <option value="dark_theme">ğŸŒ™ Tema oscuro</option>
            <option value="rainbow">ğŸŒˆ ArcoÃ­ris</option>
            <option value="custom1">ğŸ”§ Personalizado 1</option>
            <option value="custom2">ğŸ”§ Personalizado 2</option>
            <option value="custom3">ğŸ”§ Personalizado 3</option>
        </select>
        <small style="color: #666; font-size: 12px;">â€» La configuraciÃ³n se guarda automÃ¡ticamente al seleccionar âœ¨</small>
    </div>
    
    <!-- å³å´ï¼šAPIã‚­ãƒ¼é–¢é€£ -->
    <div style="flex: 1; background-color: #e0e8ff; padding: 8px 10px; border-radius: 5px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 3px;">
            <span style="font-size: 14px;">API-KEY de Google para traducciÃ³nï¼š</span>
            <input type="text" name="gas_key" id="gas_key" size="30" oninput="updateOptionValues();" style="height: 22px;" />
            <a target="_blank" href="http://www.sayonari.com/trans_asr/index_asr.html" style="font-size: 11px;">[CÃ³mo crearlo]</a>
        </div>
        <div style="font-size: 13px;">
            <span id="apiModeDisplay">
                Contador de traduccionesï¼š<span id="displayTransCount">0</span><span style="color: gray; font-size: 11px;">ï¼ˆLÃ­mite gratuito: 5,000 vecesï¼‰</span>
            </span>
            ã€€TraducciÃ³nï¼š<span id="translationStatus" style="font-weight: bold; color: #666;">En espera</span>
        </div>
        <div id="chromeTranslationMode" style="display: none; margin-top: 5px; padding: 10px; background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); border-radius: 5px;">
            <div style="margin-bottom: 8px;">
                <div style="margin-bottom: 8px;">
                    <span id="chromeTranslationStatus" style="font-size: 14px; font-weight: bold; color: #1a5e3a;">
                        ğŸš€ Â¡Iniciado en Chrome con traducciÃ³n rÃ¡pida compatible!
                    </span>
                </div>
                
                <!-- ç¿»è¨³æ–¹æ³•é¸æŠã‚¹ã‚¤ãƒƒãƒ -->
                <div style="margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <span style="font-size: 14px; color: #1a5e3a; font-weight: bold;">MÃ©todo de traducciÃ³nï¼š</span>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 14px; color: #1a5e3a;">
                            <input type="radio" name="translationMethod" value="chrome" id="translationMethodChrome" 
                                   onchange="switchTranslationMethod()" checked>
                            Integrado en Chrome (rÃ¡pido)
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 14px; color: #1a5e3a;">
                            <input type="radio" name="translationMethod" value="gas" id="translationMethodGas" 
                                   onchange="switchTranslationMethod()">
                            GAS API
                        </label>
                    </div>
                </div>
                
                <!-- Chromeå†…è”µç¿»è¨³é¸æŠæ™‚ã®æ³¨æ„æ›¸ã -->
                <div id="chromeTranslationNotice" style="font-size: 12px; color: #666; line-height: 1.3;">
                    <span id="chromeTranslationNoticeText">â€»El mÃ©todo integrado en Chrome (rÃ¡pido) estÃ¡ disponible desde Chrome 138 en adelante</span>
                </div>
            </div>
            <div id="modelDownloadArea" style="display: none; margin-top: 8px; padding: 10px; background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%); border-radius: 5px; border: 2px solid #ffc107;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button id="preloadModelBtn" onclick="preloadTranslationModel()" style="padding: 8px 16px; background: #ff6b6b; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                        ğŸ“¥ Descargar modelo
                    </button>
                    <span id="modelQueueStatus" style="padding: 4px 8px; background: rgba(255, 255, 255, 0.8); border-radius: 4px; font-size: 12px; color: #666; font-weight: bold; display: none;">
                        ğŸ“¦ Restantes: 0
                    </span>
                    <span id="modelStatusText" style="font-size: 13px; color: #333; font-weight: bold;"></span>
                </div>
            </div>
            <div id="downloadStatusArea" style="display: none; margin-top: 8px; padding: 8px; background: rgba(255, 255, 255, 0.9); border-radius: 4px;">
                <span id="downloadStatusText" style="font-size: 13px; color: #333;"></span>
            </div>
        </div>
    </div>
</div>
<HR>

<!-- # ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š (ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) ######################### -->
<table style="border-collapse: separate; border-spacing: 0px;">
<tr>
    <td></td>
    <td style="text-align: center; width: 50px;">Color del texto</td>
    <td style="text-align: center; width: 50px;">Color del borde</td>
    <td style="text-align: center; width: 120px;">TamaÃ±o</td>
    <td style="text-align: center; width: 120px;">Grosor (bold)</td>
    <td style="text-align: center; width: 120px;">Ancho del contorno</td>
</tr>
<tr>
    <td style="width: 60px;">Reconocimiento:</td>
    <td style="text-align: center;">
        <input id="color1" type="color" value="#ffffff" oninput="changeTextColor('fg',this.value,1); updateOptionValues(only_url=true)" />
    </td>
    <td style="text-align: center;">
        <input id="st_color1" type="color" value="#000000" oninput="changeTextColor('bg',this.value,1); updateOptionValues(only_url=true)" />
    </td>
    <td style="text-align: center;">
        <input id="size1" type="range" value="25" min="0" max="40" step="0.1" oninput="document.getElementById('asr_frame').contentWindow.document.getElementById('speech_text').style.fontSize = this.value + 'pt'; document.getElementById('text_size_view1').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_size_view1">25</span>px
    </td>
    <td style="text-align: center;">
        <input id="weight1" type="range" value="900" min="100" max="900" step="100" oninput="document.getElementById('asr_frame').contentWindow.document.getElementById('speech_text').style.fontWeight = this.value; document.getElementById('text_weight_view1').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_weight_view1">900</span>
    </td>
    <td style="text-align: center;">
        <input id="st_width1" type="range" value="6" min="0" max="20" step="0.1" oninput="setTextBorder(this.value,1); document.getElementById('text_st_size_view1').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_st_size_view1">6</span>pt
    </td>
</tr>
<tr>
    <td>TraducciÃ³n 1:</td>
    <td style="text-align: center;">
        <input id="color2" type="color" value="#ffffff" oninput="changeTextColor('fg',this.value,2); updateOptionValues(only_url=true)" />
    </td>
    <td style="text-align: center;">
        <input id="st_color2" type="color" value="#000000" oninput="changeTextColor('bg',this.value,2); updateOptionValues(only_url=true)" />
    </td>
    <td style="text-align: center;">
        <input id="size2" type="range" value="25" min="0" max="40" step="0.1" oninput="document.getElementById('asr_frame').contentWindow.document.getElementById('trans_text').style.fontSize = this.value + 'pt'; document.getElementById('text_size_view2').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_size_view2">25</span>px
    </td>
    <td style="text-align: center;">
        <input id="weight2" type="range" value="900" min="100" max="900" step="100" oninput="document.getElementById('asr_frame').contentWindow.document.getElementById('trans_text').style.fontWeight = this.value; document.getElementById('text_weight_view2').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_weight_view2">900</span>
    </td>
    <td style="text-align: center;">
        <input id="st_width2" type="range" value="6" min="0" max="20" step="0.1" oninput="setTextBorder(this.value,2); document.getElementById('text_st_size_view2').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_st_size_view2">6</span>pt
    </td>
</tr>
<tr>
    <td>TraducciÃ³n 2:</td>
    <td style="text-align: center;">
        <input id="color3" type="color" value="#ffffff" oninput="changeTextColor('fg',this.value,3); updateOptionValues(only_url=true)" />
    </td>
    <td style="text-align: center;">
        <input id="st_color3" type="color" value="#000000" oninput="changeTextColor('bg',this.value,3); updateOptionValues(only_url=true)" />
    </td>
    <td style="text-align: center;">
        <input id="size3" type="range" value="25" min="0" max="40" step="0.1" oninput="document.getElementById('asr_frame').contentWindow.document.getElementById('trans_text2').style.fontSize = this.value + 'pt'; document.getElementById('text_size_view3').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_size_view3">25</span>px
    </td>
    <td style="text-align: center;">
        <input id="weight3" type="range" value="900" min="100" max="900" step="100" oninput="document.getElementById('asr_frame').contentWindow.document.getElementById('trans_text2').style.fontWeight = this.value; document.getElementById('text_weight_view3').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_weight_view3">900</span>
    </td>
    <td style="text-align: center;">
        <input id="st_width3" type="range" value="6" min="0" max="20" step="0.1" oninput="setTextBorder(this.value,3); document.getElementById('text_st_size_view3').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_st_size_view3">6</span>pt
    </td>
</tr>
<tr>
    <td>TraducciÃ³n 3:</td>
    <td style="text-align: center;">
        <input id="color4" type="color" value="#ffffff" oninput="changeTextColor('fg',this.value,4); updateOptionValues(only_url=true)" />
    </td>
    <td style="text-align: center;">
        <input id="st_color4" type="color" value="#000000" oninput="changeTextColor('bg',this.value,4); updateOptionValues(only_url=true)" />
    </td>
    <td style="text-align: center;">
        <input id="size4" type="range" value="25" min="0" max="40" step="0.1" oninput="document.getElementById('asr_frame').contentWindow.document.getElementById('trans_text3').style.fontSize = this.value + 'pt'; document.getElementById('text_size_view4').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_size_view4">25</span>px
    </td>
    <td style="text-align: center;">
        <input id="weight4" type="range" value="900" min="100" max="900" step="100" oninput="document.getElementById('asr_frame').contentWindow.document.getElementById('trans_text3').style.fontWeight = this.value; document.getElementById('text_weight_view4').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_weight_view4">900</span>
    </td>
    <td style="text-align: center;">
        <input id="st_width4" type="range" value="6" min="0" max="20" step="0.1" oninput="setTextBorder(this.value,4); document.getElementById('text_st_size_view4').innerHTML=this.value; updateOptionValues(only_url=true)" />
        <span id="text_st_size_view4">6</span>pt
    </td>
</tr>
</table>

Color de fondo:<input id="bgcolor" type="color" value="#00ff00" oninput="document.getElementById('asr_frame').contentWindow.document.bgColor=this.value; changeTextColor('imb',this.value,1); updateOptionValues(only_url=true)" />

<HR>

<!-- # è¨€èªé¸æŠè¨­å®š ######################### -->
Idioma de reconocimiento:
<select id="recog" onchange="updateOptionValues(only_url=false); checkAllTranslationModels();">
    <option value="ja" selected>JaponÃ©s</option>
    <option value="en-US">InglÃ©s</option>
    <option value="ko">Coreano</option>
    <option value="zh-CN">Chino (simplificado)</option>
    <option value="zh-TW">Chino (tradicional)</option>
    <option value="zh-HK">CantonÃ©s (Hong Kong)</option>
    <option value="fr-FR">FrancÃ©s</option>
    <option value="it-IT">Italiano</option>
    <option value="de-DE">AlemÃ¡n</option>
    <option value="tr-TR">Turco</option>
    <option value="sv-SE">Sueco</option>
    <option value="pl-PL">Polaco</option>
    <option value="uk-UA">Ucraniano</option>
    <option value="ru-RU">Ruso</option>
    <option value="es-ES">EspaÃ±ol</option>
    <option value="pt-PT">PortuguÃ©s</option>
    <option value="nl-NL">HolandÃ©s</option>
    <option value="id-ID">Indonesio</option>
    <option value="vi-VN">Vietnamita</option>
    <option value="th-TH">TailandÃ©s</option>
    <option value="ar-SA">Ãrabe</option>
    <option value="el-GR">Griego</option>
</select>ã€€ã€€

Fuenteã€€ï¼š
<select name="speech_text_font_selector" id="speech_text_font_selector" onchange="applySelectedFont(this, 'speech_text'); selectFont(); updateOptionValues();">
    <option value="direct">[Fuente en PC]</option>
    <option value="M PLUS\\ 1p">M PLUS 1p</option>
    <option value="M PLUS Rounded\\ 1c" selected>M PLUS Rounded 1c</option>
	<option value="Komika Axis">Komika Axis</option>
	<option value="Bangers">Bangers</option>
    <option value="Mamelon">Mamelon</option>
    <option value="YasashisaB">YasashisaB</option>
    <option value="HuiFont29">HuiFont29</option>
    <option value="Hachi Maru Pop">Hachi Maru Pop</option>
    <option value="MkPOP">851 Makapop</option>
    <option value="bananaslipplus">Banana Slip Plus</option>
    <option value="katyou">Katyou</option>
    <option value="TanukiMagic">Tanuki Magic</option>
    <option value="hakidame">Hakidame</option>
    <option value="umeboshi">Umeboshi</option>
    <option value="Jiyucho">Jiyucho</option>
    <option value="HitmoR">Hitmo</option>
    <option value="nishikiteki">Nishikiteki</option>
    <option value="Yusei Magic">Yusei Magic</option>
    <option value="Nikumaru">Nikumaru</option>
    <option value="KTEGAKI">Kawaii Handwriting</option>
    <option value="JKGL">JK Gothic L</option>
    <option value="Reggae One">Reggae One</option>
    <option value="OhisamaFont">Ohisama</option>
    <option value="nukamiso">Nukamiso</option>
    <option value="genkai">Genkai Mincho</option>
    <option value="CP">Check Point</option>
    <option value="Noto Sans JP">Noto Sans JP</option>
    <option value="Sawarabi Gothic">Sawarabi Gothic</option>
    <option value="Nico Moji">Nico Moji</option>
</select>ã€€
Fuente en PCï¼š<select id="speech_text_system_font" onchange="applySystemFont(this.value, 'speech_text'); updateOptionValues();"></select>
<input type="text" id="speech_text_direct_font" placeholder="Ingresa nombre de fuente" style="width: 200px; margin-left: 10px;" disabled oninput="applyDirectFont(this.value, 'speech_text'); updateOptionValues();">
<span id="font_api_status" style="font-size: 12px; margin-left: 10px;"></span><br>

Idioma de traducciÃ³n (1):
<select id="trans" onchange="updateOptionValues(only_url=false, transNum=1); checkTranslationModel(1, event);">
    <option value="none" selected>Ninguno</option>
    <option value="ja">JaponÃ©s</option>
    <option value="en">InglÃ©s</option>
    <option value="ko">Coreano</option>
    <option value="zh-CN">Chino (simplificado)</option>
    <option value="zh-TW">Chino (tradicional)</option>
    <option value="zh-HK">CantonÃ©s (Hong Kong)</option>
    <option value="fr">FrancÃ©s</option>
    <option value="it">Italiano</option>
    <option value="de">AlemÃ¡n</option>
    <option value="tr">Turco</option>
    <option value="sv">Sueco</option>
    <option value="pl">Polaco</option>
    <option value="uk">Ucraniano</option>
    <option value="ru">Ruso</option>
    <option value="es">EspaÃ±ol</option>
    <option value="pt">PortuguÃ©s</option>
    <option value="nl">HolandÃ©s</option>
    <option value="id">Indonesio</option>
    <option value="vi">Vietnamita</option>
    <option value="th">TailandÃ©s</option>
    <option value="ar">Ãrabe</option>
    <option value="so">SomalÃ­</option>
    <option value="el">Griego</option>
</select>ã€€ã€€

Fuenteã€€ï¼š
<select name="trans_text_font_selector" id="trans_text_font_selector" onchange="applySelectedFont(this, 'trans_text'); selectFont(); updateOptionValues();">
    <option value="direct">[Fuente en PC]</option>
    <option value="M PLUS\\ 1p">M PLUS 1p</option>
    <option value="M PLUS Rounded\\ 1c" selected>M PLUS Rounded 1c</option>
	<option value="Komika Axis">Komika Axis</option>
	<option value="Bangers">Bangers</option>
    <option value="Mamelon">Mamelon</option>
    <option value="YasashisaB">YasashisaB</option>
    <option value="HuiFont29">HuiFont29</option>
    <option value="Hachi Maru Pop">Hachi Maru Pop</option>
    <option value="MkPOP">851 Makapop</option>
    <option value="bananaslipplus">Banana Slip Plus</option>
    <option value="katyou">Katyou</option>
    <option value="TanukiMagic">Tanuki Magic</option>
    <option value="hakidame">Hakidame</option>
    <option value="umeboshi">Umeboshi</option>
    <option value="Jiyucho">Jiyucho</option>
    <option value="HitmoR">Hitmo</option>
    <option value="nishikiteki">Nishikiteki</option>
    <option value="Yusei Magic">Yusei Magic</option>
    <option value="Nikumaru">Nikumaru</option>
    <option value="KTEGAKI">Kawaii Handwriting</option>
    <option value="JKGL">JK Gothic L</option>
    <option value="Reggae One">Reggae One</option>
    <option value="OhisamaFont">Ohisama</option>
    <option value="nukamiso">Nukamiso</option>
    <option value="genkai">Genkai Mincho</option>
    <option value="CP">Check Point</option>
    <option value="Noto Sans JP">Noto Sans JP</option>
    <option value="Sawarabi Gothic">Sawarabi Gothic</option>
    <option value="Nico Moji">Nico Moji</option>
</select>ã€€
Fuente en PCï¼š<select id="trans_text_system_font" onchange="applySystemFont(this.value, 'trans_text'); updateOptionValues();"></select>
<input type="text" id="trans_text_direct_font" placeholder="Ingresa nombre de fuente" style="width: 200px; margin-left: 10px;" disabled oninput="applyDirectFont(this.value, 'trans_text'); updateOptionValues();"><br>

Idioma de traducciÃ³n (2):
<select id="trans2" onchange="updateOptionValues(only_url=false, transNum=2); checkTranslationModel(2, event);">
    <option value="none" selected>Ninguno</option>
    <option value="ja">JaponÃ©s</option>
    <option value="en">InglÃ©s</option>
    <option value="ko">Coreano</option>
    <option value="zh-CN">Chino (simplificado)</option>
    <option value="zh-TW">Chino (tradicional)</option>
    <option value="zh-HK">CantonÃ©s (Hong Kong)</option>
    <option value="fr">FrancÃ©s</option>
    <option value="it">Italiano</option>
    <option value="de">AlemÃ¡n</option>
    <option value="tr">Turco</option>
    <option value="sv">Sueco</option>
    <option value="pl">Polaco</option>
    <option value="uk">Ucraniano</option>
    <option value="ru">Ruso</option>
    <option value="es">EspaÃ±ol</option>
    <option value="pt">PortuguÃ©s</option>
    <option value="nl">HolandÃ©s</option>
    <option value="id">Indonesio</option>
    <option value="vi">Vietnamita</option>
    <option value="th">TailandÃ©s</option>
    <option value="ar">Ãrabe</option>
    <option value="so">SomalÃ­</option>
    <option value="el">Griego</option>
</select>ã€€ã€€

Fuenteã€€ï¼š
<select name="trans_text2_font_selector" id="trans_text2_font_selector" onchange="applySelectedFont(this, 'trans_text2'); selectFont(); updateOptionValues();">
    <option value="direct">[Fuente en PC]</option>
    <option value="M PLUS\\ 1p">M PLUS 1p</option>
    <option value="M PLUS Rounded\\ 1c" selected>M PLUS Rounded 1c</option>
	<option value="Komika Axis">Komika Axis</option>
	<option value="Bangers">Bangers</option>
    <option value="Mamelon">Mamelon</option>
    <option value="YasashisaB">YasashisaB</option>
    <option value="HuiFont29">HuiFont29</option>
    <option value="Hachi Maru Pop">Hachi Maru Pop</option>
    <option value="MkPOP">851 Makapop</option>
    <option value="bananaslipplus">Banana Slip Plus</option>
    <option value="katyou">Katyou</option>
    <option value="TanukiMagic">Tanuki Magic</option>
    <option value="hakidame">Hakidame</option>
    <option value="umeboshi">Umeboshi</option>
    <option value="Jiyucho">Jiyucho</option>
    <option value="HitmoR">Hitmo</option>
    <option value="nishikiteki">Nishikiteki</option>
    <option value="Yusei Magic">Yusei Magic</option>
    <option value="Nikumaru">Nikumaru</option>
    <option value="KTEGAKI">Kawaii Handwriting</option>
    <option value="JKGL">JK Gothic L</option>
    <option value="Reggae One">Reggae One</option>
    <option value="OhisamaFont">Ohisama</option>
    <option value="nukamiso">Nukamiso</option>
    <option value="genkai">Genkai Mincho</option>
    <option value="CP">Check Point</option>
    <option value="Noto Sans JP">Noto Sans JP</option>
    <option value="Sawarabi Gothic">Sawarabi Gothic</option>
    <option value="Nico Moji">Nico Moji</option>
</select>ã€€
Fuente en PCï¼š<select id="trans_text2_system_font" onchange="applySystemFont(this.value, 'trans_text2'); updateOptionValues();"></select>
<input type="text" id="trans_text2_direct_font" placeholder="Ingresa nombre de fuente" style="width: 200px; margin-left: 10px;" disabled oninput="applyDirectFont(this.value, 'trans_text2'); updateOptionValues();"><br>

Idioma de traducciÃ³n (3):
<select id="trans3" onchange="updateOptionValues(only_url=false, transNum=3); checkTranslationModel(3, event);">
    <option value="none" selected>Ninguno</option>
    <option value="ja">JaponÃ©s</option>
    <option value="en">InglÃ©s</option>
    <option value="ko">Coreano</option>
    <option value="zh-CN">Chino (simplificado)</option>
    <option value="zh-TW">Chino (tradicional)</option>
    <option value="zh-HK">CantonÃ©s (Hong Kong)</option>
    <option value="fr">FrancÃ©s</option>
    <option value="it">Italiano</option>
    <option value="de">AlemÃ¡n</option>
    <option value="tr">Turco</option>
    <option value="sv">Sueco</option>
    <option value="pl">Polaco</option>
    <option value="uk">Ucraniano</option>
    <option value="ru">Ruso</option>
    <option value="es">EspaÃ±ol</option>
    <option value="pt">PortuguÃ©s</option>
    <option value="nl">HolandÃ©s</option>
    <option value="id">Indonesio</option>
    <option value="vi">Vietnamita</option>
    <option value="th">TailandÃ©s</option>
    <option value="ar">Ãrabe</option>
    <option value="so">SomalÃ­</option>
    <option value="el">Griego</option>
</select>ã€€ã€€

Fuenteã€€ï¼š
<select name="trans_text3_font_selector" id="trans_text3_font_selector" onchange="applySelectedFont(this, 'trans_text3'); selectFont(); updateOptionValues();">
    <option value="direct">[Fuente en PC]</option>
    <option value="M PLUS\\ 1p">M PLUS 1p</option>
    <option value="M PLUS Rounded\\ 1c" selected>M PLUS Rounded 1c</option>
	<option value="Komika Axis">Komika Axis</option>
	<option value="Bangers">Bangers</option>
    <option value="Mamelon">Mamelon</option>
    <option value="YasashisaB">YasashisaB</option>
    <option value="HuiFont29">HuiFont29</option>
    <option value="Hachi Maru Pop">Hachi Maru Pop</option>
    <option value="MkPOP">851 Makapop</option>
    <option value="bananaslipplus">Banana Slip Plus</option>
    <option value="katyou">Katyou</option>
    <option value="TanukiMagic">Tanuki Magic</option>
    <option value="hakidame">Hakidame</option>
    <option value="umeboshi">Umeboshi</option>
    <option value="Jiyucho">Jiyucho</option>
    <option value="HitmoR">Hitmo</option>
    <option value="nishikiteki">Nishikiteki</option>
    <option value="Yusei Magic">Yusei Magic</option>
    <option value="Nikumaru">Nikumaru</option>
    <option value="KTEGAKI">Kawaii Handwriting</option>
    <option value="JKGL">JK Gothic L</option>
    <option value="Reggae One">Reggae One</option>
    <option value="OhisamaFont">Ohisama</option>
    <option value="nukamiso">Nukamiso</option>
    <option value="genkai">Genkai Mincho</option>
    <option value="CP">Check Point</option>
    <option value="Noto Sans JP">Noto Sans JP</option>
    <option value="Sawarabi Gothic">Sawarabi Gothic</option>
    <option value="Nico Moji">Nico Moji</option>
</select>ã€€
Fuente en PCï¼š<select id="trans_text3_system_font" onchange="applySystemFont(this.value, 'trans_text3'); updateOptionValues();"></select>
<input type="text" id="trans_text3_direct_font" placeholder="Ingresa nombre de fuente" style="width: 200px; margin-left: 10px;" disabled oninput="applyDirectFont(this.value, 'trans_text3'); updateOptionValues();"><br>

<HR>
<!-- # è¡Œé–“èª¿æ•´ ######################### -->
<div style="background-color: #f0f0f0; padding: 8px; border-radius: 5px; margin: 5px 0;">
    <strong>Espaciado entre lÃ­neasï¼š</strong>
    Reconocimientoâ†’TraducciÃ³n 1
    <input type="range" id="line_spacing_1" min="0" max="50" value="0" 
           oninput="document.getElementById('line_spacing_1_value').textContent = this.value + 'px'; updateLineSpacing('speech_text', this.value); updateOptionValues();"
           style="width: 80px; vertical-align: middle;">
    <span id="line_spacing_1_value" style="display: inline-block; width: 35px; text-align: right;">0px</span>
    ã€€
    TraducciÃ³n 1â†’2
    <input type="range" id="line_spacing_2" min="0" max="50" value="0" 
           oninput="document.getElementById('line_spacing_2_value').textContent = this.value + 'px'; updateLineSpacing('trans_text', this.value); updateOptionValues();"
           style="width: 80px; vertical-align: middle;">
    <span id="line_spacing_2_value" style="display: inline-block; width: 35px; text-align: right;">0px</span>
    ã€€
    TraducciÃ³n 2â†’3
    <input type="range" id="line_spacing_3" min="0" max="50" value="0" 
           oninput="document.getElementById('line_spacing_3_value').textContent = this.value + 'px'; updateLineSpacing('trans_text2', this.value); updateOptionValues();"
           style="width: 80px; vertical-align: middle;">
    <span id="line_spacing_3_value" style="display: inline-block; width: 35px; text-align: right;">0px</span>
</div>

<HR>
<!-- # ãƒ†ã‚­ã‚¹ãƒˆã®æƒãˆ ######################### -->
AlineaciÃ³n del texto:ã€€
Horizontal:
<select id="textAlign" onchange="updateOptionValues()">
    <option value="left">Alinear a la izquierda</option>
    <option value="center" selected>Centrar</option>
    <option value="right">Alinear a la derecha</option>
</select>

ã€€Vertical:
<select id="v_align" onchange="updateOptionValues()">
    <option value="top" selected>Arriba</option>
    <option value="bottom">Abajo</option>
</select><BR>

<!-- # ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹è¡Œ ######################### -->
Saltos de lÃ­nea del texto:
<select id="whiteSpace" onchange="updateOptionValues()">
    <option value="nowrap">Sin saltos de lÃ­nea</option>
    <option value="" selected>Ajustar al ancho de pantalla</option>
</select><BR>
<HR>


<!-- éŸ³é‡Mostraræ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆéŸ³å£°èªè­˜ãƒ‡ãƒã‚¤ã‚¹ã¨ã®ä¸ä¸€è‡´ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ··ä¹±é˜²æ­¢ã®ãŸã‚ï¼‰ -->







<HR>

<!-- # ãƒ†ã‚­ã‚¹ãƒˆMostrarã‚’â—ç§’å¾Œã«æ¶ˆã™ ######################### -->
Â¿DespuÃ©s de cuÃ¡ntos milisegundos eliminar la oraciÃ³n?ã€€ã€€ã€€ï¼šã€€
<input type="text" name="timer" id="timer" size="10" oninput="updateOptionValues();" />milisegundosã€€
<span style="display: inline-block; vertical-align: middle;">
    <!-- éŸ³å£°èªè­˜ç”¨ã‚¿ã‚¤ãƒãƒ¼ãƒãƒ¼ï¼ˆå·¦ï¼‰ -->
    <div id="speechTimerProgressContainer" style="display: inline-block; width: 140px; height: 26px; background: linear-gradient(135deg, #fff5f5 0%, #ffd0cc 100%); border: 2px solid #cc8888; border-radius: 13px; margin-left: 10px; position: relative; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
        <div id="speechTimerProgressBar" style="height: 100%; background: linear-gradient(90deg, #FF6B6B 0%, #FFA07A 50%, #FFE4E1 100%); width: 0%; transition: width 0.1s linear; border-radius: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
        <div id="speechTimerProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 13px; font-weight: bold; color: #333; text-shadow: 1px 1px 2px rgba(255,255,255,0.8); letter-spacing: 0.5px;">ğŸ¤En espera</div>
    </div>
    <!-- ç¿»è¨³ç”¨ã‚¿ã‚¤ãƒãƒ¼ãƒãƒ¼ï¼ˆå³ï¼‰ -->
    <div id="transTimerProgressContainer" style="display: inline-block; width: 140px; height: 26px; background: linear-gradient(135deg, #f0f8ff 0%, #cce7ff 100%); border: 2px solid #8888cc; border-radius: 13px; margin-left: 8px; position: relative; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
        <div id="transTimerProgressBar" style="height: 100%; background: linear-gradient(90deg, #2196F3 0%, #64B5F6 50%, #BBDEFB 100%); width: 0%; transition: width 0.1s linear; border-radius: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
        <div id="transTimerProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 13px; font-weight: bold; color: #333; text-shadow: 1px 1px 2px rgba(255,255,255,0.8); letter-spacing: 0.5px;">ğŸŒEn espera</div>
    </div>
</span><BR>

<!-- # æ–‡ã®çµ‚ã‚ã‚Š ######################### -->
Â¿DespuÃ©s de cuÃ¡ntos milisegundos de silencio cortar la oraciÃ³n?ï¼šã€€
<input type="text" name="short_pause" value="750" id="short_pause" size="10" oninput="updateOptionValues();" />milisegundos (ingresa nÃºmerosåŠè§’. 1000 milisegundos = 1 segundo)<BR>
ï¼ˆ500ï¼šcortar inmediatamenteï½œ750ï¼šnormalï½œ1000ï¼šconectarã€€Ajusta. Si no ingresas nada, funcionarÃ¡ igual que antes.ï¼‰<BR>
<HR>


<!-- # æ£’èª­ã¿ã¡ã‚ƒã‚“é€£æº ######################### -->
- Usar integraciÃ³n con Bouyomi-chanï¼š<input type="checkbox" id="bouyomi" onchange="updateOptionValues()"> â† Marca si lo usas. Detalles â†’ <a target="_blank" href="https://twitter.com/sayonari/status/1386937837682003968">twitter</a><BR>
<!-- # ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãƒ¯ãƒ¼ãƒ‰å¯¾å¿œã™ã‚‹ï¼ ######################### -->
- <font color="red">Desactivar</font> el manejo de palabras sensibles (reemplazo con ***)ï¼š<input type="checkbox" id="anti_sexual" onchange="updateOptionValues()"> <BR>
<HR>

<!-- # URL view & copy button ############### -->
<!-- URL :  -->
<!-- <textarea name="url" id="url" rows="7" cols="90"></textarea><BR> -->
<!-- ã€€ã€€ã€€<input type="button" value="copy to clipboard" id="textarea_copy" onclick="document.getElementsByTagName('textarea')[0].select();document.execCommand('copy');"> -->
<!-- ã€€<a id="open_link" target="_self" href="">[Abrir en la misma pestaÃ±a]</a><BR>
Â¡Si abres en otra ventana se iniciarÃ¡n dos y ambas se detendrÃ¡n! Â¡Ten cuidado de no iniciar mÃºltiples instancias!<BR> -->
<!-- <HR> -->

<!-- # è¨­å®šã‚»ãƒ¼ãƒ–ï¼†ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ ################## -->
ã€€<button onclick="saveSettings()">Guardar configuraciÃ³n en PC</button>ã€€
<button onclick="loadSettings()">Cargar configuraciÃ³n desde el navegador</button>ã€€ï¼šCuando termines, guarda tu archivo de configuraciÃ³n.ã€€<BR>

<HR>

<!-- # .bat download ãƒœã‚¿ãƒ³ ############################## -->
Generar archivo .batï¼š<BR>
Si usas esto, <font color="red">Â¡no se detendrÃ¡ incluso en juegos a pantalla completa!</font> Para mÃ¡s detalles â†’ï¼ˆ<a target="_blank" href="https://www.youtube.com/watch?v=8-UXx_tVeYk">Video explicativo</a>ï¼‰<BR>
Descarga el archivo .bat y el archivo de configuraciÃ³n.<BR>

<table border="1" style="width: auto;"><tr><td>
<table style="width: auto;">
    <tr>
        <td width="180">Para Windowsï¼š</td>
        <td><button onclick="generateBatFile('win')">Generar archivo .bat de inicio para Windows</button></td>
        <td><button onclick="saveSettings()">Guardar configuraciÃ³n en PC</button></td>
    </tr>
</tr>
</table>
</td></tr></table>
<BR>
    
<table border="1" style="width: auto;"><tr><td>
<table style="width: auto;">
    <tr>
        <td width="180">Para Macï¼š</td>
        <td><button onclick="generateBatFile('mac')">Generar archivo .command de inicio para Mac</button></td>
        <td><button onclick="saveSettings()">Guardar configuraciÃ³n en PC</button></td>
    </tr>
</table>
</td></tr></table>

<HR>

<!-- # dummy è¦‹ãˆãªã„æ•°å­— ############################## -->
<input style="display: none;" type="text" name="frame_height" id="frame_height" value="30%" size="10" oninput="updateOptionValues();" />


<BR><BR><BR>
</div><BR>

<script>
// Chrome Translation API ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦Mostrarã‚’æ›´æ–°
function checkChromeTranslationAPI() {
    // Chrome Translation APIãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if ('Translator' in self) {
        // Chrome Translation APIãŒåˆ©ç”¨å¯èƒ½
        document.getElementById('chromeTranslationMode').style.display = 'block';
        document.getElementById('apiModeDisplay').style.display = 'none';
        
        // APIã‚­ãƒ¼å…¥åŠ›æ¬„ã‚‚è¦–è¦šçš„ã«å¤‰æ›´
        const apiKeyInput = document.getElementById('gas_key');
        if (apiKeyInput) {
            apiKeyInput.style.backgroundColor = '#f0f0f0';
            apiKeyInput.placeholder = 'No necesario en modo Chrome rÃ¡pido';
        }
        
        // ç¿»è¨³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚æ›´æ–°
        const statusEl = document.getElementById('translationStatus');
        if (statusEl) {
            statusEl.textContent = 'Modo rÃ¡pido Chrome';
            statusEl.style.color = '#2e7d32';
        }
        
        console.log('ğŸš€ Chrome Translation API (Chrome 138+) detectado - Modo de traducciÃ³n rÃ¡pida activado');
        return true;
    } else {
        // Chrome Translation APIãŒåˆ©ç”¨ä¸å¯ï¼ˆé€šå¸¸ã®GAS APIãƒ¢ãƒ¼ãƒ‰ï¼‰
        console.log('Chrome Translation API no disponible - Funcionando en modo GAS API');
        return false;
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒã‚§ãƒƒã‚¯
window.addEventListener('DOMContentLoaded', function() {
    checkChromeTranslationAPI();
    
    // ç¿»è¨³æ–¹æ³•ã‚’localStorageã‹ã‚‰å¾©å…ƒ
    setTimeout(() => {
        applyTranslationMethodOnLoad();
    }, 100);
    
    // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰å…¨ç¿»è¨³ãƒ¢ãƒ‡ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆiframeã®æº–å‚™ã‚’å¾…ã¤ï¼‰
    setTimeout(() => {
        checkAllTranslationModels();
    }, 2000);
});
</script>

</body>










<!-- # ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ########################################### -->

<!-- # å­—å¹•ã¡ã‚ƒã‚“è¨­å®šé …ç›®ã®ãƒ­ãƒ¼ãƒ‰ã¨ï¼Œç”»é¢ã¸ã®åæ˜  ############################## -->
<script type="text/javascript">
    const currentURL = window.location.origin + window.location.pathname;
    let base_url = currentURL.replace("index.html", "");
    base_url += "main.html?";
    base_url = base_url.replace("??", "?");


    // config å€¤ã€€ä¸€è¦§ ////////////////
    config_values = ["gas_key", "textAlign", "v_align", "whiteSpace", "bgcolor", "frame_height"
        , "recog", "size1", "weight1", "color1", "st_color1", "st_width1"
        , "trans", "size2", "weight2", "color2", "st_color2", "st_width2"
        , "trans2", "size3", "weight3", "color3", "st_color3", "st_width3"
        , "trans3", "size4", "weight4", "color4", "st_color4", "st_width4"
        , "timer", "short_pause"
        , "bouyomi", "anti_sexual"
        , "speech_text_font_selector", "trans_text_font_selector", "trans_text2_font_selector", "trans_text3_font_selector"
        , "speech_text_system_font", "trans_text_system_font", "trans_text2_system_font", "trans_text3_system_font"
        , "speech_text_direct_font", "trans_text_direct_font", "trans_text2_direct_font", "trans_text3_direct_font"
        , "line_spacing_1", "line_spacing_2", "line_spacing_3"
        , "translation_method"];

    // æ–°ç‰ˆï¼šå…¨è¨­å®šã¯jimakuChan_presetsã§ç®¡ç†ï¼ˆjimakuChan_configã¯å»ƒæ­¢ï¼‰
    // configã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯Preajustesä¿å­˜æ™‚ã®ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿åé›†ç”¨ã®ã¿
    const config = {};

    // ç¿»è¨³ç”»é¢ã¨URLã‚’åˆæœŸåŒ– ///////////////
    // åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã¯è¨­å®šã‚’åæ˜ ã—ãŸURLã‚’ç”Ÿæˆã—ã¦ã‹ã‚‰èª­ã¿è¾¼ã‚€
    // updateOptionValues(true); // URLç”Ÿæˆã®ã¿ - DOMè¦ç´ ãŒã¾ã å­˜åœ¨ã—ãªã„ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    
    // è¨­å®šã‚’å«ã‚€URLã§iframeã‚’èª­ã¿è¾¼ã‚€
    var initial_url = base_url + "textAlign=" + (config.textAlign || "center") + "&v_align=" + (config.v_align || "bottom")
                    + "&bgcolor=" + (config.bgcolor || "#00ff00")
                    + "&size1=" + (config.size1 || "25") + "&weight1=" + (config.weight1 || "900") + "&color1=" + (config.color1 || "#ffffff")
                    + "&st_color1=" + (config.st_color1 || "#000000") + "&st_width1=" + (config.st_width1 || "6")
                    + "&size2=" + (config.size2 || "25") + "&weight2=" + (config.weight2 || "900") + "&color2=" + (config.color2 || "#ffffff")
                    + "&st_color2=" + (config.st_color2 || "#000000") + "&st_width2=" + (config.st_width2 || "6")
                    + "&size3=" + (config.size3 || "25") + "&weight3=" + (config.weight3 || "900") + "&color3=" + (config.color3 || "#ffffff")
                    + "&st_color3=" + (config.st_color3 || "#000000") + "&st_width3=" + (config.st_width3 || "6")
                    + "&size4=" + (config.size4 || "25") + "&weight4=" + (config.weight4 || "900") + "&color4=" + (config.color4 || "#ffffff")
                    + "&st_color4=" + (config.st_color4 || "#000000") + "&st_width4=" + (config.st_width4 || "6");
    
    console.log('URL de carga inicial:', initial_url);
    document.getElementById('asr_frame').src = initial_url;
    // document.getElementById('url').innerHTML = base_url;
    
    // iframeãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã«è¨­å®šã‚’åæ˜ 
    document.getElementById('asr_frame').onload = function() {
        console.log('iframe cargado completamente');
        setTimeout(applyInitialSettings, 300);
    };
    // frame_heightã®åˆæœŸåŒ–ã¯Preajustesèª­ã¿è¾¼ã¿å¾Œã«è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯å‰Šé™¤
    // applyFrameHeighté–¢æ•°ã§å‡¦ç†ã•ã‚Œã‚‹


    // Fuenteã®ç›´æ¥å…¥åŠ›ã®å ´åˆï¼Œãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã€ã‚·ã‚¹ãƒ†ãƒ Fuenteãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆ¶å¾¡ ////////////////////
    function selectFont() {
        var speech_text_font_selector = document.getElementById('speech_text_font_selector').value;
        var trans_text_font_selector = document.getElementById('trans_text_font_selector').value;
        var trans_text2_font_selector = document.getElementById('trans_text2_font_selector').value;
        var trans_text3_font_selector = document.getElementById('trans_text3_font_selector').value;
        
        console.log("Estado de selecciÃ³n de fuente: " + speech_text_font_selector);
        
        // éŸ³å£°èªè­˜Fuente
        var speechSystemFont = document.getElementById('speech_text_system_font');
        if (speech_text_font_selector === "direct") {
            if (speechSystemFont) {
                speechSystemFont.disabled = false;
                speechSystemFont.style.backgroundColor = '';
                speechSystemFont.style.color = '';
            }
        } else {
            if (speechSystemFont) {
                speechSystemFont.disabled = true;
                speechSystemFont.style.backgroundColor = '#f0f0f0';
                speechSystemFont.style.color = '#999';
                speechSystemFont.value = ''; // é¸æŠã‚’ã‚¯ãƒªã‚¢
            }
        }

        // ç¿»è¨³1Fuente
        var transSystemFont = document.getElementById('trans_text_system_font');
        if (trans_text_font_selector === "direct") {
            if (transSystemFont) {
                transSystemFont.disabled = false;
                transSystemFont.style.backgroundColor = '';
                transSystemFont.style.color = '';
            }
        } else {
            if (transSystemFont) {
                transSystemFont.disabled = true;
                transSystemFont.style.backgroundColor = '#f0f0f0';
                transSystemFont.style.color = '#999';
                transSystemFont.value = '';
            }
        }

        // ç¿»è¨³2Fuente
        var trans2SystemFont = document.getElementById('trans_text2_system_font');
        if (trans_text2_font_selector === "direct") {
            if (trans2SystemFont) {
                trans2SystemFont.disabled = false;
                trans2SystemFont.style.backgroundColor = '';
                trans2SystemFont.style.color = '';
            }
        } else {
            if (trans2SystemFont) {
                trans2SystemFont.disabled = true;
                trans2SystemFont.style.backgroundColor = '#f0f0f0';
                trans2SystemFont.style.color = '#999';
                trans2SystemFont.value = '';
            }
        }

        // ç¿»è¨³3Fuente
        var trans3SystemFont = document.getElementById('trans_text3_system_font');
        if (trans_text3_font_selector === "direct") {
            if (trans3SystemFont) {
                trans3SystemFont.disabled = false;
                trans3SystemFont.style.backgroundColor = '';
                trans3SystemFont.style.color = '';
            }
        } else {
            if (trans3SystemFont) {
                trans3SystemFont.disabled = true;
                trans3SystemFont.style.backgroundColor = '#f0f0f0';
                trans3SystemFont.style.color = '#999';
                trans3SystemFont.value = '';
            }
        }

        updateOptionValues();
    }
    
    // åˆæœŸè¨­å®šã®åæ˜ 
    selectFont();
    // PCå†…Fuenteã¨ç›´æ¥å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    initializeSystemFontFields();
    
    // PreajustesåˆæœŸåŒ–ã¯æœ€Abajoéƒ¨ã§å®Ÿè¡Œ

    // åˆæœŸè¨­å®šã‚’é©ç”¨ã™ã‚‹é–¢æ•°
    function applyInitialSettings() {
        try {
            // iframeå†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…ã¤
            if (document.getElementById('asr_frame').contentWindow && 
                document.getElementById('asr_frame').contentWindow.document) {
                
                console.log('Aplicando configuraciÃ³n inicial...');
                
                // ã¾ãšè¨­å®šã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ›´æ–°ï¼ˆiframeå†èª­ã¿è¾¼ã¿ï¼‰
                updateOptionValues(false);
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰DOMã®ç›´æ¥æ“ä½œã‚‚å®Ÿè¡Œ
                setTimeout(function() {
                    applyAllSettings();
                    // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒãƒ¼æ•°å€¤Mostrarã‚’æ›´æ–°
                    updateVisualSettings();
                    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
                    updatePageTitle();
                    console.log('ConfiguraciÃ³n inicial aplicada completamente');
                }, 200);
                
            } else {
                // ã¾ã æº–å‚™ã§ãã¦ã„ãªã„å ´åˆã¯å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
                setTimeout(applyInitialSettings, 100);
            }
        } catch (error) {
            console.error('Error al aplicar configuraciÃ³n inicial:', error);
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚å†è©¦è¡Œ
            setTimeout(applyInitialSettings, 200);
        }
    }

    // ç¿»è¨³æ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
    function switchTranslationMethod() {
        const chromeRadio = document.getElementById('translationMethodChrome');
        const gasRadio = document.getElementById('translationMethodGas');
        const notice = document.getElementById('chromeTranslationNotice');
        const modelArea = document.getElementById('modelDownloadArea');
        
        if (chromeRadio.checked) {
            // Chromeå†…è”µç¿»è¨³é¸æŠæ™‚
            notice.style.display = 'block';
            // ãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®MostrarçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            checkAllTranslationModels();
            
            // iframeå†…ã«ç¿»è¨³æ–¹æ³•å¤‰æ›´ã‚’é€šçŸ¥ï¼ˆã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã®ãŸã‚ï¼‰
            updateTranslationMethodInIframe('chrome');
        } else {
            // GAS APIé¸æŠæ™‚
            notice.style.display = 'none';
            if (modelArea) {
                modelArea.style.display = 'none';
            }
            
            // iframeå†…ã«ç¿»è¨³æ–¹æ³•å¤‰æ›´ã‚’é€šçŸ¥ï¼ˆã‚¿ã‚¤ãƒãƒ¼åœæ­¢ã®ãŸã‚ï¼‰
            updateTranslationMethodInIframe('gas');
        }
        
        // localStorage ã«ä¿å­˜
        const selectedMethod = chromeRadio.checked ? 'chrome' : 'gas';
        saveTranslationMethodToStorage(selectedMethod);
        
        // Preajustesã«è‡ªå‹•ä¿å­˜
        updateOptionValues();
    }
    
    // iframeå†…ã®ç¿»è¨³æ–¹æ³•è¨­å®šã‚’æ›´æ–°
    function updateTranslationMethodInIframe(method = null) {
        const iframe = document.getElementById('asr_frame');
        if (!iframe || !iframe.contentWindow) {
            console.warn('iframe no preparado, omitiendo actualizaciÃ³n del mÃ©todo de traducciÃ³n');
            return;
        }
        
        try {
            const selectedMethod = method || document.querySelector('input[name="translationMethod"]:checked').value;
            iframe.contentWindow.postMessage({
                type: 'updateTranslationMethod',
                method: selectedMethod
            }, '*');
            console.log(`MÃ©todo de traducciÃ³n actualizado a ${selectedMethod} (temporizador ${selectedMethod === 'chrome' ? 'iniciado' : 'detenido'})`);
        } catch (error) {
            console.error('Error al actualizar mÃ©todo de traducciÃ³n en iframe:', error);
        }
    }
    
    function setupMessageListener() {
        // Chromeç¿»è¨³ã‚¿ã‚¤ãƒãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆãƒã‚°ä¿®æ­£æ¸ˆã¿ï¼‰
    }
    
    
    // localStorageä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ©Ÿèƒ½
    function saveTranslationMethodToStorage(method) {
        try {
            localStorage.setItem('jimakuChan_translationMethod', method);
            console.log('MÃ©todo de traducciÃ³n guardado en localStorage:', method);
        } catch (error) {
            console.warn('Error al guardar mÃ©todo de traducciÃ³n en localStorage:', error);
        }
    }
    
    function loadTranslationMethodFromStorage() {
        try {
            const saved = localStorage.getItem('jimakuChan_translationMethod');
            return saved || 'chrome'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯Chromeå†…è”µ
        } catch (error) {
            console.warn('Error al cargar mÃ©todo de traducciÃ³n desde localStorage:', error);
            return 'chrome';
        }
    }
    
    // åˆæœŸåŒ–æ™‚ã«ç¿»è¨³æ–¹æ³•ã®å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getTranslationMethod() {
        const chromeRadio = document.getElementById('translationMethodChrome');
        if (!chromeRadio) {
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ãŒã¾ã å­˜åœ¨ã—ãªã„å ´åˆã¯localStorageã‹ã‚‰å–å¾—
            return loadTranslationMethodFromStorage();
        }
        return chromeRadio.checked ? 'chrome' : 'gas';
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç¿»è¨³æ–¹æ³•ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
    function applyTranslationMethodOnLoad() {
        const savedMethod = loadTranslationMethodFromStorage();
        
        const chromeRadio = document.getElementById('translationMethodChrome');
        const gasRadio = document.getElementById('translationMethodGas');
        const notice = document.getElementById('chromeTranslationNotice');
        
        if (chromeRadio && gasRadio && notice) {
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’è¨­å®š
            if (savedMethod === 'chrome') {
                chromeRadio.checked = true;
                gasRadio.checked = false;
                notice.style.display = 'block';
            } else {
                chromeRadio.checked = false;
                gasRadio.checked = true;
                notice.style.display = 'none';
            }
            
            // iframeå†…ã«ã‚‚é€šçŸ¥
            updateTranslationMethodInIframe();
            
            console.log('MÃ©todo de traducciÃ³n restaurado desde localStorage:', savedMethod);
        }
    }
    
    // iframeå†…ã®ç¿»è¨³è¨€èªã‚’å‹•çš„ã«æ›´æ–°
    function updateTranslationLanguageInIframe(transNum, newLang) {
        const iframe = document.getElementById('asr_frame');
        if (!iframe || !iframe.contentWindow) return;
        
        try {
            // iframeå†…ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
            if (transNum === 1) {
                iframe.contentWindow.arg_trans = newLang === 'none' ? null : newLang;
            } else if (transNum === 2) {
                iframe.contentWindow.arg_trans2 = newLang === 'none' ? null : newLang;
            } else if (transNum === 3) {
                iframe.contentWindow.arg_trans3 = newLang === 'none' ? null : newLang;
            }
            
            console.log(`Idioma de traducciÃ³n ${transNum} actualizado a ${newLang}`);
        } catch (error) {
            console.error('Error al actualizar idioma de traducciÃ³n en iframe:', error);
        }
    }
    
    // URLã«ä»˜ã‘ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å€¤ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ //////////
    function updateOptionValues(only_url=false, transNum=null) {
        for (const p of config_values) {
            // translation_methodã¯ç‰¹åˆ¥å‡¦ç†ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
            if (p === 'translation_method') {
                continue;
            }
            const element = document.getElementById(p);
            if (element) {
                eval("var " + p + " = element.value;");
            }
        }
        var bouyomi = document.getElementById('bouyomi').checked;
        var anti_sexual = document.getElementById('anti_sexual').checked;
        var translation_method = getTranslationMethod();
        
        // Fuenteå¤‰æ•°ã®åˆæœŸåŒ–
        var speech_text_font = '';
        var trans_text_font = '';
        var trans_text2_font = '';
        var trans_text3_font = '';

        var new_url = base_url + "textAlign=" + textAlign + "&v_align=" + v_align 
                     + "&recog=" + recog 
                     + "&bgcolor=" + bgcolor

                     + "&size1=" + size1 + "&weight1=" + weight1 + "&color1=" + color1
                     + "&st_color1=" + st_color1 + "&st_width1=" + st_width1

                     + "&size2=" + size2 + "&weight2=" + weight2 + "&color2=" + color2
                     + "&st_color2=" + st_color2 + "&st_width2=" + st_width2

                     + "&size3=" + size3 + "&weight3=" + weight3 + "&color3=" + color3
                     + "&st_color3=" + st_color3 + "&st_width3=" + st_width3

                     + "&size4=" + size4 + "&weight4=" + weight4 + "&color4=" + color4
                     + "&st_color4=" + st_color4 + "&st_width4=" + st_width4;
        if(whiteSpace != '') {new_url = new_url + "&whiteSpace=" + whiteSpace;} 
        if(trans != 'none') {new_url = new_url + "&trans=" + trans;} 
        if(trans2 != 'none') {new_url = new_url + "&trans2=" + trans2;} 
        if(trans3 != 'none') {new_url = new_url + "&trans3=" + trans3;} 

        // font ã®å‡¦ç†
        console.log('[DEBUG] Procesamiento de fuente:', {
            speech_text_font_selector,
            speech_text_system_font,
            speech_text_direct_font
        });
        if (speech_text_font_selector !== "direct") {
            speech_text_font = speech_text_font_selector;
        } else {
            // ç›´æ¥æŒ‡å®šã®å ´åˆã€ç›´æ¥å…¥åŠ›ã®å€¤ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ã‚·ã‚¹ãƒ†ãƒ Fuenteã®å€¤ã‚’ä½¿ç”¨
            // ãŸã ã—ã€ã‚·ã‚¹ãƒ†ãƒ Fuenteã®å€¤ãŒ'direct'ã®å ´åˆã¯ç„¡è¦–
            if (speech_text_direct_font && speech_text_direct_font !== '') {
                speech_text_font = speech_text_direct_font;
            } else if (speech_text_system_font && speech_text_system_font !== '' && speech_text_system_font !== 'direct') {
                speech_text_font = speech_text_system_font;
            } else {
                speech_text_font = '';
            }
            console.log('[DEBUG] Fuente directa seleccionada:', speech_text_font);
        }
        if (trans_text_font_selector !== "direct") {
            trans_text_font = trans_text_font_selector;
        } else {
            if (trans_text_direct_font && trans_text_direct_font !== '') {
                trans_text_font = trans_text_direct_font;
            } else if (trans_text_system_font && trans_text_system_font !== '' && trans_text_system_font !== 'direct') {
                trans_text_font = trans_text_system_font;
            } else {
                trans_text_font = '';
            }
        }
        if (trans_text2_font_selector !== "direct") {
            trans_text2_font = trans_text2_font_selector;
        } else {
            if (trans_text2_direct_font && trans_text2_direct_font !== '') {
                trans_text2_font = trans_text2_direct_font;
            } else if (trans_text2_system_font && trans_text2_system_font !== '' && trans_text2_system_font !== 'direct') {
                trans_text2_font = trans_text2_system_font;
            } else {
                trans_text2_font = '';
            }
        }
        if (trans_text3_font_selector !== "direct") {
            trans_text3_font = trans_text3_font_selector;
        } else {
            if (trans_text3_direct_font && trans_text3_direct_font !== '') {
                trans_text3_font = trans_text3_direct_font;
            } else if (trans_text3_system_font && trans_text3_system_font !== '' && trans_text3_system_font !== 'direct') {
                trans_text3_font = trans_text3_system_font;
            } else {
                trans_text3_font = '';
            }
        }
        if(speech_text_font != '') {
            new_url = new_url + "&speech_text_font=" + speech_text_font;
            console.log('[DEBUG] Agregando speech_text_font a URL:', speech_text_font);
        } else {
            console.log('[DEBUG] speech_text_font estÃ¡ vacÃ­o, no se agrega a URL');
        } 
        if(trans_text_font != '') {new_url = new_url + "&trans_text_font=" + trans_text_font;} 
        if(trans_text2_font != '') {new_url = new_url + "&trans_text2_font=" + trans_text2_font;} 
        if(trans_text3_font != '') {new_url = new_url + "&trans_text3_font=" + trans_text3_font;} 

        if(timer != '') {new_url = new_url + "&timer=" + timer;} 
        if(short_pause != '') {new_url = new_url + "&short_pause=" + short_pause;}
        
        // è¡Œé–“è¨­å®š
        if(line_spacing_1 != '') {new_url = new_url + "&line_spacing_1=" + line_spacing_1;}
        if(line_spacing_2 != '') {new_url = new_url + "&line_spacing_2=" + line_spacing_2;}
        if(line_spacing_3 != '') {new_url = new_url + "&line_spacing_3=" + line_spacing_3;} 

        if(bouyomi == true) {new_url = new_url + "&bouyomi=" + bouyomi;}
        // anti_sexualã¯ã€ãƒã‚§ãƒƒã‚¯ON=å‰Šé™¤ã‚’ã‚„ã‚ã‚‹(false)ã€ãƒã‚§ãƒƒã‚¯OFF=å‰Šé™¤ã™ã‚‹(true)
        if(anti_sexual == true) {
            new_url = new_url + "&anti_sexual=" + "false";
        } else {
            new_url = new_url + "&anti_sexual=" + "true";
        }
        if(gas_key != '') {new_url = new_url + "&gas_key=" + gas_key;}
        if(translation_method != '') {new_url = new_url + "&translation_method=" + translation_method;}
   
        // config ã®æ›´æ–°
        for (const p of config_values) {
            config[p] = eval(p);
        }
        
        // checkboxè¨­å®šã‚‚configã«è¿½åŠ ï¼ˆPreajustesä¿å­˜ç”¨ã®ã¿ï¼‰
        config.bouyomi = bouyomi;
        config.anti_sexual = anti_sexual;
        config.translation_method = translation_method;

        // æ³¨æ„ï¼šjimakuChan_configã¸ã®ä¿å­˜ã¯å»ƒæ­¢ã€‚å…¨ã¦Preajustesã§ç®¡ç†

        // Preajustesã¸ã®è‡ªå‹•ä¿å­˜ï¼ˆPreajustesèª­ã¿è¾¼ã¿ä¸­ã§ãªã‘ã‚Œã°å®Ÿè¡Œï¼‰
        console.log('updateOptionValues - VerificaciÃ³n de guardado automÃ¡tico:', 'isLoadingPreset:', isLoadingPreset, 'currentPreset:', currentPreset);
        if (!isLoadingPreset) {
            console.log('Guardado automÃ¡tico programado - Ejecutando en 100ms');
            setTimeout(saveCurrentPreset, 100);
        } else {
            console.log('Guardado automÃ¡tico omitido - Cargando preajuste');
        }

        // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°
        updatePageTitle();

        // èªè­˜ã¡ã‚ƒã‚“ç”»é¢ã®æ›´æ–° ///////
        if(only_url == false) {
            // ç¿»è¨ƒè¨€èªå¤‰æ›´æ™‚ã¯iframeå†…ã®å¤‰æ•°ã‚’æ›´æ–°ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã›ãšï¼‰
            if (transNum !== null) {
                if (transNum === 1) {
                    updateTranslationLanguageInIframe(1, trans);
                } else if (transNum === 2) {
                    updateTranslationLanguageInIframe(2, trans2);
                } else if (transNum === 3) {
                    updateTranslationLanguageInIframe(3, trans3);
                }
            } else {
                // ç¿»è¨³è¨€èªä»¥å¤–ã®å¤‰æ›´æ™‚ã¯ãƒªãƒ­ãƒ¼ãƒ‰
                console.log('Actualizando iframe URL:', new_url);
                document.getElementById('asr_frame').src = new_url;
            }
        }

        // document.getElementById('url').innerHTML = new_url;
        // document.getElementById('open_link').href = new_url;

        return 0;
    }

    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updatePageTitle() {
        try {
            const presetSelect = document.getElementById('presetSelect');
            if (presetSelect && presetSelect.selectedIndex > 0) {
                const selectedText = presetSelect.options[presetSelect.selectedIndex].text;
                document.title = `jimakuChan: SubtÃ­tulos con reconocimiento de voz [${selectedText}]`;
            } else {
                document.title = 'SubtÃ­tulos en Vivo: Reconocimiento de voz y subtÃ­tulos [CONFIG]';
            }
        } catch (error) {
            console.log('Error al actualizar tÃ­tulo:', error);
            document.title = 'SubtÃ­tulos en Vivo';
        }
    }

    // åˆæœŸåŒ–æ™‚ã¯é…å»¶å®Ÿè¡Œ
    setTimeout(function() {
        updateOptionValues();
    }, 100);

    // PCã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹Fuenteã‚’æ¤œå‡ºã™ã‚‹é–¢æ•°
    function detectSystemFonts() {
        // ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ Fuenteã®ãƒªã‚¹ãƒˆï¼ˆæ‹¡å¼µç‰ˆï¼‰
        const commonFonts = [
            // JaponÃ©sFuente - Windows
            'Yu Gothic', 'Yu Gothic UI', 'Yu Gothic Medium', 'Yu Mincho', 'Meiryo', 'Meiryo UI',
            'MS Gothic', 'MS PGothic', 'MS UI Gothic', 'MS Mincho', 'MS PMincho',
            'BIZ UDGothic', 'BIZ UDPGothic', 'BIZ UDMincho', 'BIZ UDPMincho',
            'UD Digi Kyokasho', 'UD Digi Kyokasho N-R', 'UD Digi Kyokasho NK-R',
            
            // JaponÃ©sFuente - Mac
            'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Hiragino Kaku Gothic Pro',
            'Hiragino Mincho ProN', 'Hiragino Mincho Pro', 'Hiragino Maru Gothic ProN',
            'Osaka', 'Osaka-Mono', 'Tsukushi A Round Gothic', 'Tsukushi B Round Gothic',
            'YuKyokasho', 'YuKyokasho Yoko', 'Klee',
            
            // JaponÃ©sFuente - å…±é€š/Web
            'Noto Sans JP', 'Noto Sans CJK JP', 'Noto Serif JP', 'Noto Serif CJK JP',
            'Source Han Sans', 'Source Han Serif', 'æºãƒè§’ã‚´ã‚·ãƒƒã‚¯', 'æºãƒæ˜æœ',
            'Sawarabi Gothic', 'Sawarabi Mincho', 'Kosugi', 'Kosugi Maru',
            'M PLUS 1p', 'M PLUS Rounded 1c', 'M PLUS 2',
            
            // InglÃ©sFuente - åŸºæœ¬
            'Arial', 'Arial Black', 'Arial Narrow', 'Arial Unicode MS',
            'Helvetica', 'Helvetica Neue', 'Times New Roman', 'Georgia',
            'Verdana', 'Tahoma', 'Trebuchet MS', 'Comic Sans MS',
            'Courier', 'Courier New', 'Lucida Console', 'Consolas',
            
            // InglÃ©sFuente - è¿½åŠ 
            'Calibri', 'Cambria', 'Candara', 'Century', 'Century Gothic',
            'Franklin Gothic', 'Futura', 'Garamond', 'Gill Sans',
            'Impact', 'Lucida Grande', 'Lucida Sans', 'Monaco',
            'Palatino', 'Palatino Linotype', 'Segoe UI', 'Segoe Print',
            
            // ã‚·ã‚¹ãƒ†ãƒ Fuente
            'system-ui', '-apple-system', 'BlinkMacSystemFont',
            'SF Pro Display', 'SF Pro Text', 'SF Mono',
            '.AppleSystemUIFont', 'Apple Color Emoji',
            'Segoe UI Emoji', 'Segoe UI Symbol', 'Roboto',
            
            // è¿½åŠ ã®è£…é£¾Fuente
            'HGPå‰µè‹±è§’ï½ºï¾ï½¼ï½¯ï½¸UB', 'HGPå‰µè‹±è§’ï¾ï¾Ÿï½¯ï¾Œï¾Ÿä½“', 'HGPæ•™ç§‘æ›¸ä½“', 'HGPï½ºï¾ï½¼ï½¯ï½¸E',
            'HGPï½ºï¾ï½¼ï½¯ï½¸M', 'HGPæ˜æœE', 'HGSå‰µè‹±è§’ï½ºï¾ï½¼ï½¯ï½¸UB', 'HGSå‰µè‹±è§’ï¾ï¾Ÿï½¯ï¾Œï¾Ÿä½“',
            'DFå¹³æˆæ˜æœä½“', 'DFå¹³æˆã‚´ã‚·ãƒƒã‚¯ä½“', 'DFPå¹³æˆæ˜æœä½“', 'DFPå¹³æˆã‚´ã‚·ãƒƒã‚¯ä½“'
        ];

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        const testString = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789ã‚ã„ã†ãˆãŠã‚«ã‚­ã‚¯ã‚±ã‚³æ¼¢å­—';
        
        // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆFuenteï¼‰ã®TamaÃ±oã‚’æ¸¬å®š
        context.font = '12px monospace';
        const baselineWidth = context.measureText(testString).width;
        
        const availableFonts = [];
        
        for (const font of commonFonts) {
            context.font = `12px "${font}", monospace`;
            const width = context.measureText(testString).width;
            
            // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨å¹…ãŒç•°ãªã‚Œã°ã€ãã®FuenteãŒåˆ©ç”¨å¯èƒ½
            if (width !== baselineWidth) {
                availableFonts.push(font);
            }
        }
        
        return availableFonts;
    }

    // Fuenteé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
    function initializeFontSelectors() {
        const availableFonts = detectSystemFonts();
        const fontSelectors = ['speech_text_system_font', 'trans_text_system_font', 'trans_text2_system_font', 'trans_text3_system_font'];
        
        fontSelectors.forEach(selectorId => {
            const selector = document.getElementById(selectorId);
            if (selector) {
                // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
                selector.innerHTML = '';
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Selecciona';
                selector.appendChild(defaultOption);
                
                // [ç›´æ¥æŒ‡å®š]ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                const directOption = document.createElement('option');
                directOption.value = 'direct';
                directOption.textContent = '[Especificar directamente]';
                selector.appendChild(directOption);
                
                // æ¤œå‡ºã•ã‚ŒãŸFuenteã‚’è¿½åŠ 
                availableFonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.textContent = font;
                    option.style.fontFamily = font;
                    selector.appendChild(option);
                });
            }
        });
        
        // åˆæœŸåŒ–å¾Œã«çŠ¶æ…‹ã‚’æ­£ã—ãè¨­å®š
        setTimeout(selectFont, 100);
    }

    // Fuenteã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateFontStatus(message, color) {
        const statusElement = document.getElementById('font_api_status');
        if (!statusElement) return;
        
        statusElement.innerHTML = message;
        statusElement.style.color = color || '#666';
        console.log('Estado de fuente:', message);
    }
    
    // Font Access APIå¯¾å¿œçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦Mostrarã™ã‚‹é–¢æ•°ï¼ˆMostrarã‚’ç„¡åŠ¹åŒ–ï¼‰
    function checkFontAPIStatus() {
        if ('queryLocalFonts' in window) {
            // updateFontStatus('Font Access APIå¯¾å¿œï¼ˆå®Ÿé¨“çš„æ©Ÿèƒ½ï¼‰', '#008000');
            
            // å®Ÿéš›ã«ä½¿ãˆã‚‹ã‹ãƒ†ã‚¹ãƒˆ
            window.queryLocalFonts().then(fonts => {
                // updateFontStatus(`Font Access APIå¯¾å¿œï¼ˆ${fonts.length}å€‹ã®Fuenteæ¤œå‡ºï¼‰`, '#008000');
            }).catch(error => {
                // updateFontStatus('Font Access APIï¼ˆæ¨©é™ã‚¨ãƒ©ãƒ¼ï¼‰', '#ff6600');
            });
        } else {
            // updateFontStatus('é™å®šãƒªã‚¹ãƒˆä½¿ç”¨ä¸­ï¼ˆFont Access APIéå¯¾å¿œï¼‰', '#666');
        }
    }
    
    // ç›´æ¥æŒ‡å®šFuenteã‚’é©ç”¨ã™ã‚‹é–¢æ•°
    // FuenteãŒå®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
    function checkFontExists(fontName) {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        const testString = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789ã‚ã„ã†ãˆãŠã‚«ã‚­ã‚¯ã‚±ã‚³æ¼¢å­—';
        
        // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹Fuenteï¼‰ã®TamaÃ±oã‚’æ¸¬å®š
        context.font = '12px monospace';
        const monoWidth = context.measureText(testString).width;
        
        context.font = '12px sans-serif';
        const sansWidth = context.measureText(testString).width;
        
        // æŒ‡å®šã•ã‚ŒãŸFuenteã§æ¸¬å®š
        context.font = `12px "${fontName}", monospace`;
        const testWidth = context.measureText(testString).width;
        
        // monospaceã¨åŒã˜å¹…ãªã‚‰ã€FuenteãŒè¦‹ã¤ã‹ã‚‰ãšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚ŒãŸå¯èƒ½æ€§ãŒé«˜ã„
        return testWidth !== monoWidth;
    }

    function applyDirectFont(fontName, targetElement) {
        if (!fontName || !targetElement) return;
        
        try {
            const iframe = document.getElementById('asr_frame');
            if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                console.log('iframe no listo, la fuente se aplicarÃ¡ mÃ¡s tarde');
                updateFontStatus('â³ iframe preparÃ¡ndose...', '#ff6600');
                return;
            }
            
            const iframeDoc = iframe.contentWindow.document;
            const element = iframeDoc.getElementById(targetElement);
            
            if (element) {
                // Fuenteåã®å¤§Textoå°Textoã‚’èª¿æ•´ï¼ˆKleeãªã©ï¼‰
                if (fontName.toLowerCase() === 'klee') {
                    fontName = 'Klee';
                }
                
                // Fuenteã‚’é©ç”¨
                const fontFamily = `"${fontName}", sans-serif`;
                element.style.fontFamily = fontFamily;
                
                // å­è¦ç´ ã«ã‚‚é©ç”¨ï¼ˆ-bg, -fg, -imbï¼‰
                const bgElement = iframeDoc.getElementById(targetElement + '-bg');
                const fgElement = iframeDoc.getElementById(targetElement + '-fg');
                const imbElement = iframeDoc.getElementById(targetElement + '-imb');
                
                if (bgElement) bgElement.style.fontFamily = fontFamily;
                if (fgElement) fgElement.style.fontFamily = fontFamily;
                if (imbElement) imbElement.style.fontFamily = fontFamily;
                
                console.log(`Fuente directa aplicada: ${fontName} â†’ ${targetElement}`);
                
                // FuenteãŒå®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const fontExists = checkFontExists(fontName);
                
                if (fontExists) {
                    // ã•ã‚‰ã«å®Ÿéš›ã«é©ç”¨ã•ã‚ŒãŸã‹ã‚’ç¢ºèª
                    const computedStyle = iframeDoc.defaultView.getComputedStyle(element);
                    const appliedFont = computedStyle.fontFamily;
                    
                    if (appliedFont.includes(fontName)) {
                        // updateFontStatus(`âœ… ç›´æ¥æŒ‡å®š: ${fontName}`, '#008000');
                    } else {
                        // updateFontStatus(`âš ï¸ ç›´æ¥æŒ‡å®š: ${fontName} (aplicado parcialmente)`, '#ff6600');
                    }
                } else {
                    // updateFontStatus(`âŒ Error de fuente ç›´æ¥æŒ‡å®š: ${fontName}`, '#cc0000');
                }
            }
        } catch (error) {
            console.log('Error al aplicar fuente directa:', error);
            // updateFontStatus(`âŒ Error: ${error.message}`, '#cc0000');
        }
    }
    
    // ã‚·ã‚¹ãƒ†ãƒ Fuenteã‚’é©ç”¨ã™ã‚‹é–¢æ•°
    function applySystemFont(fontName, targetElement) {
        // å¯¾å¿œã™ã‚‹ç›´æ¥å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—
        const directFontInput = document.getElementById(targetElement + '_direct_font');
        
        if (fontName === 'direct') {
            // [ç›´æ¥æŒ‡å®š]ãŒé¸ã°ã‚ŒãŸå ´åˆã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
            if (directFontInput) {
                directFontInput.disabled = false;
                directFontInput.style.backgroundColor = '';
                directFontInput.style.color = '';
                directFontInput.focus();
            }
        } else {
            // ãã‚Œä»¥å¤–ã®å ´åˆã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã‚¯ãƒªã‚¢
            if (directFontInput) {
                directFontInput.disabled = true;
                directFontInput.style.backgroundColor = '#f0f0f0';
                directFontInput.style.color = '#999';
                directFontInput.value = '';
            }
            
            // é¸æŠã•ã‚ŒãŸFuenteã‚’é©ç”¨
            if (fontName && fontName !== '') {
                try {
                    const iframe = document.getElementById('asr_frame');
                    if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                        console.log('iframe no listo, la fuente se aplicarÃ¡ mÃ¡s tarde');
                        return;
                    }
                    
                    const iframeDoc = iframe.contentWindow.document;
                    const element = iframeDoc.getElementById(targetElement);
                    if (element) {
                        // Fuenteåã®å¤§Textoå°Textoã‚’èª¿æ•´ï¼ˆKleeãªã©ï¼‰
                        if (fontName.toLowerCase() === 'klee') {
                            fontName = 'Klee';
                        }
                        
                        const fontFamily = `"${fontName}", sans-serif`;
                        element.style.fontFamily = fontFamily;
                        
                        // å­è¦ç´ ã«ã‚‚é©ç”¨ï¼ˆ-bg, -fg, -imbï¼‰
                        const bgElement = iframeDoc.getElementById(targetElement + '-bg');
                        const fgElement = iframeDoc.getElementById(targetElement + '-fg');
                        const imbElement = iframeDoc.getElementById(targetElement + '-imb');
                        
                        if (bgElement) bgElement.style.fontFamily = fontFamily;
                        if (fgElement) fgElement.style.fontFamily = fontFamily;
                        if (imbElement) imbElement.style.fontFamily = fontFamily;
                        
                        console.log(`Fuente del sistema aplicada: ${fontName} â†’ ${targetElement}`);
                        
                        // FuenteãŒå®Ÿéš›ã«é©ç”¨ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
                        const computedStyle = iframe.contentWindow.document.defaultView.getComputedStyle(element);
                        const appliedFont = computedStyle.fontFamily;
                        
                        if (appliedFont.includes(fontName)) {
                            // updateFontStatus(`âœ… Fuente en PC: ${fontName}`, '#008000');
                        } else {
                            // updateFontStatus(`âš ï¸ Fuente en PC: ${fontName} (no detectada)`, '#ff6600');
                        }
                    }
                } catch (error) {
                    console.log('Error al aplicar fuente del sistema:', error);
                }
            }
        }
    }

    // PCå†…Fuenteã¨ç›´æ¥å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
    function initializeSystemFontFields() {
        const fontTargets = ['speech_text', 'trans_text', 'trans_text2', 'trans_text3'];
        
        fontTargets.forEach(target => {
            const systemFontSelect = document.getElementById(target + '_system_font');
            const directFontInput = document.getElementById(target + '_direct_font');
            
            if (systemFontSelect && directFontInput) {
                // ä¿å­˜ã•ã‚ŒãŸå€¤ãŒã‚ã‚‹å ´åˆã¯å¾©å…ƒ
                const savedSystemFont = systemFontSelect.value;
                const savedDirectFont = directFontInput.value;
                
                // ç›´æ¥å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹ã‚’è¨­å®š
                if (savedSystemFont === 'direct') {
                    // [ç›´æ¥æŒ‡å®š]ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€FuenteåãŒç©ºã§ã‚‚æœ‰åŠ¹åŒ–
                    directFontInput.disabled = false;
                    directFontInput.style.backgroundColor = '';
                    directFontInput.style.color = '';
                    // ç›´æ¥å…¥åŠ›ã•ã‚ŒãŸFuenteãŒã‚ã‚‹å ´åˆã®ã¿é©ç”¨
                    if (savedDirectFont) {
                        applyDirectFont(savedDirectFont, target);
                    }
                } else {
                    directFontInput.disabled = true;
                    directFontInput.style.backgroundColor = '#f0f0f0';
                    directFontInput.style.color = '#999';
                    // ã‚·ã‚¹ãƒ†ãƒ Fuenteã‚’é©ç”¨
                    if (savedSystemFont && savedSystemFont !== '' && savedSystemFont !== 'direct') {
                        applySystemFont(savedSystemFont, target);
                    }
                }
            }
        });
    }
    
    // è¡Œé–“ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateLineSpacing(targetElement, spacing) {
        try {
            const iframe = document.getElementById('asr_frame');
            if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                console.log('iframe no listo para actualizar espaciado entre lÃ­neas');
                return;
            }
            
            const element = iframe.contentWindow.document.getElementById(targetElement);
            if (element) {
                element.style.marginBottom = spacing + 'px';
                console.log(`Espaciado actualizado: ${targetElement} â†’ ${spacing}px`);
            }
        } catch (error) {
            console.log('Error al actualizar espaciado:', error);
        }
    }
    
    // é¸æŠã•ã‚ŒãŸFuenteã‚’é©ç”¨ã™ã‚‹é–¢æ•°
    function applySelectedFont(selector, targetElement) {
        try {
            const iframe = document.getElementById('asr_frame');
            if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                console.log('iframe no listo, la fuente se aplicarÃ¡ mÃ¡s tarde');
                return;
            }
            
            let fontValue = selector.value;
            
            // "direct"ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚·ã‚¹ãƒ†ãƒ Fuenteé¸æŠã§å‡¦ç†ï¼‰
            if (fontValue === 'direct') {
                return;
            }
            
            // directã§ãªã„å ´åˆã€ç›´æ¥å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            const directFontInput = document.getElementById(targetElement + '_direct_font');
            if (directFontInput) {
                directFontInput.value = '';
            }
            
            // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’é™¤å»ã—ã¦Fuenteåã‚’æ­£è¦åŒ–
            fontValue = fontValue.replace(/\\\\/g, '');
            
            const iframeDoc = iframe.contentWindow.document;
            const element = iframeDoc.getElementById(targetElement);
            if (element) {
                const fontFamily = `"${fontValue}", sans-serif`;
                element.style.fontFamily = fontFamily;
                
                // å­è¦ç´ ã«ã‚‚é©ç”¨ï¼ˆ-bg, -fg, -imbï¼‰
                const bgElement = iframeDoc.getElementById(targetElement + '-bg');
                const fgElement = iframeDoc.getElementById(targetElement + '-fg');
                const imbElement = iframeDoc.getElementById(targetElement + '-imb');
                
                if (bgElement) bgElement.style.fontFamily = fontFamily;
                if (fgElement) fgElement.style.fontFamily = fontFamily;
                if (imbElement) imbElement.style.fontFamily = fontFamily;
                
                console.log(`Fuente aplicada: ${fontValue} â†’ ${targetElement}`);
                // updateFontStatus(`âœ… Fuente: ${fontValue}`, '#008000');
            }
        } catch (error) {
            console.log('Error al aplicar fuente:', error);
        }
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã®è‰²å¤‰ãˆ ---------------------------
    function changeTextColor(type, color, id) {
        try {
            var iframe = document.getElementById('asr_frame');
            if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                return;
            }
            
            var text_layer = ['fg','bg','imb'];
            var lang_line = ['speech_text','trans_text','trans_text2','trans_text3'];
            var element = iframe.contentWindow.document.getElementById(lang_line[id-1] + '-' + type);

            if (element) {
                if(type == "fg") { 
                    element.style.color = color;
                } else { 
                    element.style.webkitTextStrokeColor = color; 
                }
            }

            // type ãŒ imb ã®å ´åˆã¯ï¼Œå…¨ã¦ã®lang_lineã«åæ˜ 
            if(type == "imb") {
                for (const ll of lang_line){
                    var imbElement = iframe.contentWindow.document.getElementById(ll + '-' + type);
                    if (imbElement) {
                        imbElement.style.webkitTextStrokeColor = color;
                        imbElement.style.color = color;
                    }
                } 
            }
        } catch (error) {
            console.error('Error al cambiar color:', error);
        }
    }

    function setTextBorder(width, id) {
        try {
            var iframe = document.getElementById('asr_frame');
            if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                return;
            }
            
            var lang_line = ['speech_text','trans_text','trans_text2','trans_text3'];
            var bgElement = iframe.contentWindow.document.getElementById(lang_line[id-1] + "-bg");
            var imbElement = iframe.contentWindow.document.getElementById(lang_line[id-1] + "-imb");

            if (bgElement) {
                bgElement.style.webkitTextStrokeWidth = width + 'pt';
            }
            if (imbElement) {
                imbElement.style.webkitTextStrokeWidth = width + 'pt';
            }
        } catch (error) {
            console.error('Error al configurar borde:', error);
        }
   }

    function changeText(text, id){
        var text_layer = ['fg','bg','imb'];
        var lang_line = ['speech_text','trans_text','trans_text2','trans_text3'];

        for (const tl of text_layer){ 
            document.getElementById('asr_frame').contentWindow.document.getElementById(ll[id-1] + '-' + tl).innerHTML = text;
        }         
    }
    
    // å…¨ã¦ã®è¨­å®šã‚’é©ç”¨ã™ã‚‹é–¢æ•°
    function applyAllSettings() {
        try {
            var iframe = document.getElementById('asr_frame');
            if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                console.log('iframe no preparado, omitiendo aplicaciÃ³n de configuraciÃ³n');
                return false;
            }
            
            var iframeDoc = iframe.contentWindow.document;
            
            // èƒŒæ™¯è‰²
            var bgcolor = document.getElementById('bgcolor').value;
            if (bgcolor) {
                iframeDoc.bgColor = bgcolor;
            }
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ
            var v_align = document.getElementById('v_align').value;
            var textTable = iframeDoc.getElementById("text_table");
            if (textTable) {
                if (v_align == "top"){
                    textTable.style.bottom = -1;
                } else if(v_align == "bottom"){
                    textTable.style.bottom = 0;
                }
            }
            
            var textAlign = document.getElementById('textAlign').value;
            if (textTable && textAlign) {
                textTable.style.textAlign = textAlign;
                var tblTd = iframeDoc.getElementById("tbl_td");
                if (tblTd) {
                    tblTd.style.textAlign = textAlign;
                    if(textAlign == "right"){
                        textTable.style.direction = "rtl";
                        tblTd.style.direction = "rtl";
                        iframeDoc.body.style.direction = "rtl";
                    }
                }
            }
            
            // å„ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‰²ã¨TamaÃ±oã‚’æ›´æ–°
            for (var i = 1; i <= 4; i++) {
                changeTextColor('fg', document.getElementById('color' + i).value, i);
                changeTextColor('bg', document.getElementById('st_color' + i).value, i);
                setTextBorder(document.getElementById('st_width' + i).value, i);
                
                var lang_line = ['speech_text','trans_text','trans_text2','trans_text3'];
                var textElement = iframeDoc.getElementById(lang_line[i-1]);
                if (textElement) {
                    textElement.style.fontSize = document.getElementById('size' + i).value + 'pt';
                    textElement.style.fontWeight = document.getElementById('weight' + i).value;
                    
                    // Fuenteè¨­å®š
                    var fontSelectorIds = ['speech_text_font_selector', 'trans_text_font_selector', 'trans_text2_font_selector', 'trans_text3_font_selector'];
                    var systemFontIds = ['speech_text_system_font', 'trans_text_system_font', 'trans_text2_system_font', 'trans_text3_system_font'];
                    
                    var fontSelector = document.getElementById(fontSelectorIds[i-1]);
                    var systemFontSelector = document.getElementById(systemFontIds[i-1]);
                    
                    if (fontSelector) {
                        if (fontSelector.value === 'direct' && systemFontSelector && systemFontSelector.value) {
                            // ç›´æ¥æŒ‡å®š + ã‚·ã‚¹ãƒ†ãƒ Fuenteé¸æŠã®å ´åˆ
                            textElement.style.fontFamily = `"${systemFontSelector.value}", sans-serif`;
                            console.log('ConfiguraciÃ³n de fuente del sistema:', lang_line[i-1], systemFontSelector.value);
                        } else if (fontSelector.value !== 'direct' && fontSelector.value !== '') {
                            // PreajustesFuenteé¸æŠã®å ´åˆ
                            var fontValue = fontSelector.value.replace(/\\\\/g, '');  // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’é™¤å»
                            textElement.style.fontFamily = `"${fontValue}", sans-serif`;
                            console.log('ConfiguraciÃ³n de fuente preestablecida:', lang_line[i-1], fontValue);
                        }
                    }
                }
            }
            
            // èƒŒæ™¯è‰²ã‚’å…¨ã¦ã®imbè¦ç´ ã«é©ç”¨
            changeTextColor('imb', bgcolor, 1);
            
            // æ”¹è¡Œè¨­å®š
            var whiteSpace = document.getElementById('whiteSpace').value;
            if (textTable && whiteSpace) {
                textTable.style.whiteSpace = whiteSpace;
            }
            
            
            // ã‚·ã‚¹ãƒ†ãƒ Fuenteãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            selectFont();
            
            return true;
        } catch (error) {
            console.error('Error al aplicar configuraciÃ³n:', error);
            return false;
        }
    }

</script>

<!-- # ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ############################## -->
<script>  
    function generateFile(content, fileName) {
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = fileName;
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  
    function generateBatFile(os) {
    //   let url = document.getElementById('url').value.trim();
        let url = currentURL;
      // URLãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’è¡Œã†
      url = decodeURIComponent(url);
  
      if (url === '') {
        alert('No hay URL. Error.');
        return;
      }
      
      let content, filename;
  
      if (os === 'win') {
        content = `@echo off\r\nset "USERPROFILE=%LOCALAPPDATA%\\Google\\Chrome\\User Data\\user_jimaku_001"\r\nstart chrome.exe --disable-features=CalculateNativeWinOcclusion --user-data-dir="%USERPROFILE%" --new-window "${url}"\r\nexit /b`;
        filename = "jimakuChan_nonStop.bat";

      } else {
        content = `#!/bin/sh\n"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" --disable-features=CalculateNativeWinOcclusion --user-data-dir="Library/Application Support/Google/Chrome/user_jimaku_001"  --new-window "${url}"`;
        filename = "jimakuChan_nonStop.command";
      }
  
      generateFile(content, filename);
    }

</script>

<!-- # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã¨èª­è¾¼ ############################## -->
<script>

    // Save all presets to a file (å…¨Preajustesã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜)
    function saveSettings() {
        const presets = localStorage.getItem('jimakuChan_presets');
        if (!presets) {
            alert('Â¡No se encontraron preajustes para guardar!');
            return;
        }
        
        try {
            const presetsData = JSON.parse(presets);
            const exportData = {
                version: "2025.8.17 09:48",
                exportDate: new Date().toISOString(),
                presets: presetsData
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'jimakuChan_presets.json';
            link.click();
            URL.revokeObjectURL(link.href);
            console.log('Preajustes guardados en archivo');
        } catch (error) {
            alert('Error al guardar preajustes: ' + error.message);
            console.error('Error al guardar preajustes:', error);
        }
    }

    // Load presets from a file (Preajustesã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿)
    function loadSettings() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(readEvent) {
                try {
                    const data = JSON.parse(readEvent.target.result);
                    console.log('Archivo cargado:', data);
                    
                    // æ–°å½¢å¼ã®Preajustesãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                    if (data.presets && data.version) {
                        console.log('Cargando archivo de preajustes en nuevo formato');
                        localStorage.setItem('jimakuChan_presets', JSON.stringify(data.presets));
                        alert(`Preajustes cargados (ver.${data.version})`);
                        location.reload();
                    }
                    // æ—§å½¢å¼ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
                    else if (data && typeof data === 'object' && !data.presets) {
                        console.log('Cargando archivo de configuraciÃ³n en formato antiguo - Convirtiendo a preajustes');
                        const convertedPreset = {
                            default: {
                                name: 'ConfiguraciÃ³n cargada',
                                settings: data,
                                lastModified: new Date().toISOString(),
                                importedFrom: 'legacy_file'
                            }
                        };
                        localStorage.setItem('jimakuChan_presets', JSON.stringify(convertedPreset));
                        alert('Archivo de configuraciÃ³n antiguo convertido a preajustes y cargado');
                        location.reload();
                    }
                    else {
                        alert('Formato de archivo invÃ¡lido');
                    }
                } catch (error) {
                    alert('Error al cargar archivo: ' + error.message);
                    console.error('Error al cargar archivo:', error);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

</script>

<!-- # Preajustes de configuraciÃ³næ©Ÿèƒ½ã€€############################ -->
<script>
    // Preajustesã®å®šç¾©ï¼ˆå¯æ„›ã„é…è‰²ã§æ”¹å–„ï¼‰
    const defaultPresets = {
        default: {
            name: "ğŸ“‹ Selecciona",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "bottom",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "25",
                weight1: "900",
                color1: "#ffffff",
                st_color1: "#000000",
                st_width1: "6",
                trans: "en",
                size2: "25",
                weight2: "900",
                color2: "#ffffff",
                st_color2: "#000000",
                st_width2: "6",
                trans2: "none",
                size3: "25",
                weight3: "900",
                color3: "#ffffff",
                st_color3: "#000000",
                st_width3: "6",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "7000",
                short_pause: "750",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        gaming: {
            name: "ğŸ® Para transmisiÃ³n de juegos",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "bottom",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "28",
                weight1: "900",
                color1: "#ffffff",
                st_color1: "#ff6b9d",
                st_width1: "6",
                trans: "en",
                size2: "24",
                weight2: "900",
                color2: "#ffeb3b",
                st_color2: "#7b1fa2",
                st_width2: "4",
                trans2: "none",
                size3: "25",
                weight3: "900",
                color3: "#ffffff",
                st_color3: "#000000",
                st_width3: "6",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "5000",
                short_pause: "1000",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        meeting: {
            name: "ğŸ’¼ Para reuniones y consultas",
            settings: {
                gas_key: "",
                textAlign: "left",
                v_align: "top",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "22",
                weight1: "500",
                color1: "#2e3440",
                st_color1: "#eceff4",
                st_width1: "3",
                trans: "en",
                size2: "20",
                weight2: "500",
                color2: "#5e81ac",
                st_color2: "#eceff4",
                st_width2: "2",
                trans2: "none",
                size3: "25",
                weight3: "900",
                color3: "#ffffff",
                st_color3: "#000000",
                st_width3: "6",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "10000",
                short_pause: "750",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        language_learning: {
            name: "ğŸ“š Para aprendizaje de idiomas",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "center",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "26",
                weight1: "600",
                color1: "#2d3748",
                st_color1: "#bee3f8",
                st_width1: "4",
                trans: "en",
                size2: "22",
                weight2: "600",
                color2: "#d53f8c",
                st_color2: "#fed7e2",
                st_width2: "3",
                trans2: "none",
                size3: "22",
                weight3: "600",
                color3: "#3182ce",
                st_color3: "#bee3f8",
                st_width3: "3",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "15000",
                short_pause: "500",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        accessibility: {
            name: "â™¿ Enfocado en accesibilidad",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "bottom",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "32",
                weight1: "900",
                color1: "#ffffff",
                st_color1: "#000000",
                st_width1: "8",
                trans: "en",
                size2: "25",
                weight2: "900",
                color2: "#ffffff",
                st_color2: "#000000",
                st_width2: "6",
                trans2: "none",
                size3: "25",
                weight3: "900",
                color3: "#ffffff",
                st_color3: "#000000",
                st_width3: "6",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "7000",
                short_pause: "1500",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        cute_streaming: {
            name: "ğŸŒ¸ Para transmisiones lindas",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "bottom",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "30",
                weight1: "700",
                color1: "#ffffff",
                st_color1: "#ff69b4",
                st_width1: "5",
                trans: "en",
                size2: "26",
                weight2: "700",
                color2: "#ff1493",
                st_color2: "#ffb6c1",
                st_width2: "4",
                trans2: "none",
                size3: "25",
                weight3: "900",
                color3: "#ffffff",
                st_color3: "#000000",
                st_width3: "6",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "6000",
                short_pause: "800",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        dark_theme: {
            name: "ğŸŒ™ Tema oscuro",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "bottom",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "27",
                weight1: "600",
                color1: "#e2e8f0",
                st_color1: "#4a5568",
                st_width1: "4",
                trans: "en",
                size2: "23",
                weight2: "600",
                color2: "#81e6d9",
                st_color2: "#2d3748",
                st_width2: "3",
                trans2: "none",
                size3: "25",
                weight3: "900",
                color3: "#ffffff",
                st_color3: "#000000",
                st_width3: "6",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "7000",
                short_pause: "900",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        rainbow: {
            name: "ğŸŒˆ ArcoÃ­ris",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "bottom",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "29",
                weight1: "800",
                color1: "#ffffff",
                st_color1: "#ff0080",
                st_width1: "6",
                trans: "en",
                size2: "25",
                weight2: "800",
                color2: "#00ff80",
                st_color2: "#ff8000",
                st_width2: "5",
                trans2: "none",
                size3: "25",
                weight3: "800",
                color3: "#8080ff",
                st_color3: "#ff0080",
                st_width3: "5",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "5500",
                short_pause: "750",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        custom1: {
            name: "ğŸ”§ Personalizado 1",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "bottom",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "25",
                weight1: "900",
                color1: "#ffffff",
                st_color1: "#000000",
                st_width1: "6",
                trans: "en",
                size2: "25",
                weight2: "900",
                color2: "#ffffff",
                st_color2: "#000000",
                st_width2: "6",
                trans2: "none",
                size3: "25",
                weight3: "900",
                color3: "#ffffff",
                st_color3: "#000000",
                st_width3: "6",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "7000",
                short_pause: "750",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        custom2: {
            name: "ğŸ”§ Personalizado 2",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "bottom",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "25",
                weight1: "900",
                color1: "#ffffff",
                st_color1: "#000000",
                st_width1: "6",
                trans: "en",
                size2: "25",
                weight2: "900",
                color2: "#ffffff",
                st_color2: "#000000",
                st_width2: "6",
                trans2: "none",
                size3: "25",
                weight3: "900",
                color3: "#ffffff",
                st_color3: "#000000",
                st_width3: "6",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "7000",
                short_pause: "750",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        },
        custom3: {
            name: "ğŸ”§ Personalizado 3",
            settings: {
                gas_key: "",
                textAlign: "center",
                v_align: "bottom",
                whiteSpace: "",
                bgcolor: "#00ff00",
                recog: "ja",
                size1: "25",
                weight1: "900",
                color1: "#ffffff",
                st_color1: "#000000",
                st_width1: "6",
                trans: "en",
                size2: "25",
                weight2: "900",
                color2: "#ffffff",
                st_color2: "#000000",
                st_width2: "6",
                trans2: "none",
                size3: "25",
                weight3: "900",
                color3: "#ffffff",
                st_color3: "#000000",
                st_width3: "6",
                trans3: "none",
                size4: "25",
                weight4: "900",
                color4: "#ffffff",
                st_color4: "#000000",
                st_width4: "6",
                timer: "7000",
                short_pause: "750",
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text_font_selector: "M PLUS Rounded\\ 1c",
                trans_text2_font_selector: "M PLUS Rounded\\ 1c",
                trans_text3_font_selector: "M PLUS Rounded\\ 1c",
                speech_text_system_font: "",
                trans_text_system_font: "",
                trans_text2_system_font: "",
                trans_text3_system_font: ""
            }
        }
    };

    // ç¾åœ¨é¸æŠä¸­ã®Preajustesã‚’ä¿å­˜ï¼ˆåˆæœŸåŒ–é–¢æ•°å†…ã§è¨­å®šï¼‰
    let currentPreset = 'default';
    
    // Preajustesèª­ã¿è¾¼ã¿ä¸­ãƒ•ãƒ©ã‚°ï¼ˆè‡ªå‹•ä¿å­˜ã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹ãŸã‚ï¼‰
    let isLoadingPreset = false;
    
    // Preajustesã‚’èª­ã¿è¾¼ã‚€
    function loadPreset() {
        const presetSelect = document.getElementById('presetSelect');
        const selectedPreset = presetSelect.value;
        
        if (!selectedPreset) return;
        
        console.log('Cambio de preajuste iniciado:', selectedPreset);
        
        // Preajustesèª­ã¿è¾¼ã¿ä¸­ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆè‡ªå‹•ä¿å­˜ã‚’åœæ­¢ï¼‰
        isLoadingPreset = true;
        
        // ã€Œé¸æŠã—ã¦ãã ã•ã„ã€ãŒé¸ã°ã‚ŒãŸå ´åˆã¯è¨­å®šã‚’é©ç”¨ã—ã¦ã™ãã«å®Œäº†
        if (selectedPreset === 'default') {
            console.log('Procesando preajuste "Selecciona"');
            
            // è¨­å®šçŠ¶æ…‹ã‚’ä¿å­˜
            currentPreset = selectedPreset;
            try {
                localStorage.setItem('selectedPreset', selectedPreset);
                console.log('Estado de selecciÃ³n de preajuste guardado:', selectedPreset);
            } catch (error) {
                console.error('Error al guardar en localStorage:', error);
            }
            
            // ã¾ãšä¿å­˜æ¸ˆã¿ã®è¨­å®šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const savedPresets = JSON.parse(localStorage.jimakuChan_presets || '{}');
            let settingsToApply;
            
            if (savedPresets[selectedPreset] && savedPresets[selectedPreset].settings) {
                settingsToApply = savedPresets[selectedPreset].settings;
                console.log('Usando preajuste "Selecciona" guardado');
                console.log('Parte de la configuraciÃ³n guardada:', {
                    bgcolor: settingsToApply.bgcolor,
                    trans: settingsToApply.trans,
                    speech_text_font_selector: settingsToApply.speech_text_font_selector
                });
            } else {
                settingsToApply = defaultPresets.default.settings;
                console.log('Usando preajuste "Selecciona" por defecto (sin configuraciÃ³n guardada)');
            }
            
            // è¨­å®šã‚’é©ç”¨
            for (const [key, value] of Object.entries(settingsToApply)) {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            }
            
            // ç¿»è¨³æ–¹æ³•ã®å¾©å…ƒ
            const chromeRadio = document.getElementById('translationMethodChrome');
            const gasRadio = document.getElementById('translationMethodGas');
            const notice = document.getElementById('chromeTranslationNotice');
            
            if (chromeRadio && gasRadio && notice) {
                let methodToApply = 'chrome'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                
                if (settingsToApply.translation_method) {
                    // ä¿å­˜æ¸ˆã¿è¨­å®šã«ç¿»è¨³æ–¹æ³•ãŒã‚ã‚‹å ´åˆ
                    methodToApply = settingsToApply.translation_method;
                    console.log('MÃ©todo de traducciÃ³n restaurado desde configuraciÃ³n guardada:', methodToApply);
                } else {
                    // è¨­å®šãŒãªã„å ´åˆã¯localStorageã‹ã‚‰å–å¾—
                    methodToApply = loadTranslationMethodFromStorage();
                    console.log('MÃ©todo de traducciÃ³n restaurado desde localStorage:', methodToApply);
                }
                
                // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¨æ³¨æ„æ›¸ãã‚’è¨­å®š
                if (methodToApply === 'chrome') {
                    chromeRadio.checked = true;
                    gasRadio.checked = false;
                    notice.style.display = 'block';
                } else {
                    chromeRadio.checked = false;
                    gasRadio.checked = true;
                    notice.style.display = 'none';
                }
                
                // è¨­å®šã‚’localStorageã«ã‚‚ä¿å­˜ï¼ˆåŒæœŸã®ãŸã‚ï¼‰
                saveTranslationMethodToStorage(methodToApply);
            }
            
            // è¨­å®šã‚’åæ˜ 
            updateOptionValues(false);
            setTimeout(() => {
                applyAllSettings();
                selectFont(); // FuenteçŠ¶æ…‹ã‚‚æ›´æ–°
                initializeSystemFontFields(); // PCå†…Fuenteã¨ç›´æ¥å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
                updateVisualSettings(); // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒãƒ¼æ•°å€¤Mostrarã‚’æ›´æ–°
                applyFrameHeight(); // frame_heightï¼ˆè¨­å®šç”»é¢Mostrar/éMostrarï¼‰ã‚’é©ç”¨
            }, 100);
            
            // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            isLoadingPreset = false;
            updatePageTitle();
            
            // å¼·åˆ¶çš„ã«è‡ªå‹•ä¿å­˜ã‚’å®Ÿè¡Œ
            console.log('Preajuste "Selecciona" - Ejecutando guardado automÃ¡tico forzado');
            setTimeout(saveCurrentPreset, 200);
            
            console.log('Procesamiento de preajuste "Selecciona" completado');
            return;
        }
        
        // é¸æŠçŠ¶æ…‹ã‚’ä¿å­˜
        currentPreset = selectedPreset;
        try {
            localStorage.setItem('selectedPreset', selectedPreset);
            console.log('Estado de selecciÃ³n de preajuste guardado:', selectedPreset);
            console.log('VerificaciÃ³n de guardado:', localStorage.getItem('selectedPreset'));
        } catch (error) {
            console.error('Error al guardar en localStorage:', error);
        }
        
        let presetData = null;
        
        // ã¾ãšä¿å­˜ã•ã‚ŒãŸPreajustesã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå„ªå…ˆï¼‰
        const savedPresets = JSON.parse(localStorage.jimakuChan_presets || '{}');
        if (savedPresets[selectedPreset]) {
            presetData = savedPresets[selectedPreset].settings;
            console.log('Usando datos de preajuste guardado:', selectedPreset);
        } else if (defaultPresets[selectedPreset]) {
            // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ã¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆPreajustesã‚’ä½¿ç”¨
            presetData = defaultPresets[selectedPreset].settings;
            console.log('Usando datos de preajuste por defecto:', selectedPreset);
        }
        
        if (presetData) {
            console.log('Aplicando datos de preajuste:', Object.keys(presetData).length + ' configuraciones');
            
            // è¨­å®šã‚’é©ç”¨
            for (const key in presetData) {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = presetData[key];
                    } else {
                        element.value = presetData[key];
                    }
                }
            }
            
            // ç¿»è¨³æ–¹æ³•ã®å¾©å…ƒ
            const chromeRadio = document.getElementById('translationMethodChrome');
            const gasRadio = document.getElementById('translationMethodGas');
            const notice = document.getElementById('chromeTranslationNotice');
            
            if (chromeRadio && gasRadio && notice) {
                let methodToApply = 'chrome'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                
                if (presetData.translation_method) {
                    // Preajustesã«ç¿»è¨³æ–¹æ³•ã®è¨­å®šãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’å„ªå…ˆ
                    methodToApply = presetData.translation_method;
                    console.log('MÃ©todo de traducciÃ³n restaurado desde preajuste:', methodToApply);
                } else {
                    // Preajustesã«è¨­å®šãŒãªã„å ´åˆã¯localStorageã‹ã‚‰å–å¾—
                    methodToApply = loadTranslationMethodFromStorage();
                    console.log('MÃ©todo de traducciÃ³n restaurado desde localStorage:', methodToApply);
                }
                
                // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¨æ³¨æ„æ›¸ãã‚’è¨­å®š
                if (methodToApply === 'chrome') {
                    chromeRadio.checked = true;
                    gasRadio.checked = false;
                    notice.style.display = 'block';
                } else {
                    chromeRadio.checked = false;
                    gasRadio.checked = true;
                    notice.style.display = 'none';
                }
                
                // è¨­å®šã‚’localStorageã«ã‚‚ä¿å­˜ï¼ˆåŒæœŸã®ãŸã‚ï¼‰
                saveTranslationMethodToStorage(methodToApply);
            }
            
            // Fuenteè¨­å®šã®ç‰¹åˆ¥å‡¦ç†
            selectFont();
            
            // Mostrarã‚’æ›´æ–°ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤Mostrarãªã©ï¼‰
            updateVisualSettings();
            
            // frame_heightï¼ˆè¨­å®šç”»é¢Mostrar/éMostrarï¼‰ã‚’é©ç”¨
            applyFrameHeight();
            
            // å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ç¢ºå®Ÿãªæ›´æ–°
            console.log('Ejecutando actualizaciÃ³n forzada de preajuste...');
            
            var iframe = document.getElementById('asr_frame');
            
            // è¨­å®šã‚’é©ç”¨
            updateOptionValues(false);
            
            // è¤‡æ•°å›ã®ãƒªãƒ­ãƒ¼ãƒ‰è©¦è¡Œã§ç¢ºå®Ÿæ€§ã‚’å‘Arriba
            var reloadAttempts = 0;
            var maxAttempts = 3;
            
            function attemptReload() {
                reloadAttempts++;
                console.log(`Intento de recarga ${reloadAttempts}/${maxAttempts}`);
                
                // iframeã‚’å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
                var currentSrc = iframe.src;
                iframe.src = 'about:blank';
                
                setTimeout(function() {
                    iframe.src = currentSrc;
                    
                    // èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…æ©Ÿ
                    iframe.onload = function() {
                        console.log(`Recarga completada (${reloadAttempts}/${maxAttempts})`);
                        
                        setTimeout(function() {
                            try {
                                if (iframe.contentWindow && iframe.contentWindow.document) {
                                    console.log('Ejecutando actualizaciÃ³n directa del DOM...');
                                    var settingsApplied = applyAllSettings();
                                    
                                    if (settingsApplied || reloadAttempts >= maxAttempts) {
                                        console.log('ActualizaciÃ³n de preajuste completada');
                                        isLoadingPreset = false;
                                        
                                        // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
                                        updatePageTitle();
                                        
                                        // é€šå¸¸ã®onloadãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«Restaurar
                                        iframe.onload = function() {
                                            console.log('iframe cargado completamente');
                                            setTimeout(applyInitialSettings, 300);
                                        };
                                    } else {
                                        console.log('Error al aplicar configuraciÃ³n - Reintentando...');
                                        setTimeout(attemptReload, 500);
                                    }
                                } else {
                                    if (reloadAttempts < maxAttempts) {
                                        console.log('DOM no preparado - Reintentando...');
                                        setTimeout(attemptReload, 500);
                                    } else {
                                        console.log('Alcanzado el nÃºmero mÃ¡ximo de intentos - Finalizando');
                                        isLoadingPreset = false;
                                        
                                        // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
                                        updatePageTitle();
                                        
                                        // é€šå¸¸ã®onloadãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«Restaurar
                                        iframe.onload = function() {
                                            console.log('iframe cargado completamente');
                                            setTimeout(applyInitialSettings, 300);
                                        };
                                    }
                                }
                            } catch (error) {
                                console.error('Error al aplicar preajuste:', error);
                                if (reloadAttempts < maxAttempts) {
                                    setTimeout(attemptReload, 500);
                                } else {
                                    console.log('Finalizando debido a error');
                                    isLoadingPreset = false;
                                    
                                    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
                                    updatePageTitle();
                                    
                                    // é€šå¸¸ã®onloadãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«Restaurar
                                    iframe.onload = function() {
                                        console.log('iframe cargado completamente');
                                        setTimeout(applyInitialSettings, 300);
                                    };
                                }
                            }
                        }, 500);
                    };
                }, 100);
            }
            
            // åˆå›è©¦è¡Œã‚’é–‹å§‹
            attemptReload();
            
            console.log('Preajuste "' + selectedPreset + '" cargado completamente');
        } else {
            console.error('Datos de preajuste no encontrados:', selectedPreset);
            isLoadingPreset = false;
            
            // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            updatePageTitle();
        }
    }
    
    // ç¾åœ¨ã®Preajustesã«è¨­å®šã‚’è‡ªå‹•ä¿å­˜
    function saveCurrentPreset() {
        console.log('saveCurrentPreset llamado - currentPreset:', currentPreset, 'isLoadingPreset:', isLoadingPreset);
        
        if (!currentPreset || isLoadingPreset) {
            if (isLoadingPreset) console.log('Omitiendo guardado automÃ¡tico - Cargando preajuste');
            if (!currentPreset) console.log('Omitiendo guardado automÃ¡tico - Preajuste actual no configurado');
            return;
        }
        
        console.log('Iniciando guardado automÃ¡tico - Preajuste:', currentPreset);
        
        // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
        const currentSettings = {};
        for (const p of config_values) {
            // translation_methodã¯ç‰¹åˆ¥å‡¦ç†ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
            if (p === 'translation_method') {
                continue;
            }
            const element = document.getElementById(p);
            if (element) {
                if (element.type === 'checkbox') {
                    currentSettings[p] = element.checked;
                } else {
                    currentSettings[p] = element.value;
                }
            }
        }
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®šã‚‚å«ã‚ã‚‹
        currentSettings.bouyomi = document.getElementById('bouyomi').checked;
        currentSettings.anti_sexual = document.getElementById('anti_sexual').checked;
        currentSettings.translation_method = getTranslationMethod();
        
        // Preajustesã‚’ä¿å­˜
        const savedPresets = JSON.parse(localStorage.jimakuChan_presets || '{}');
        savedPresets[currentPreset] = {
            name: defaultPresets[currentPreset] ? defaultPresets[currentPreset].name : currentPreset,
            settings: currentSettings,
            lastModified: new Date().toISOString()
        };
        
        localStorage.jimakuChan_presets = JSON.stringify(savedPresets);
        console.log('Preajuste "' + currentPreset + '" guardado automÃ¡ticamente');
        console.log('Parte de la configuraciÃ³n guardada:', {
            bgcolor: currentSettings.bgcolor,
            size1: currentSettings.size1,
            color1: currentSettings.color1,
            recog: currentSettings.recog,
            trans: currentSettings.trans,
            speech_text_font_selector: currentSettings.speech_text_font_selector
        });
        
        // ä¿å­˜ç¢ºèªã®ãŸã‚ã€localStorageã‹ã‚‰èª­ã¿ç›´ã—
        const verifyPresets = JSON.parse(localStorage.jimakuChan_presets || '{}');
        if (verifyPresets[currentPreset]) {
            console.log('VerificaciÃ³n de guardado OK - Preajuste "' + currentPreset + '" existe');
        } else {
            console.error('VerificaciÃ³n de guardado NG - Preajuste "' + currentPreset + '" no encontrado');
        }
    }
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šä¿å­˜ã•ã‚ŒãŸPreajustesã‚’ç¢ºèª
    function debugPresets() {
        const savedPresets = JSON.parse(localStorage.jimakuChan_presets || '{}');
        console.log('=== Lista de preajustes guardados ===');
        for (const [key, value] of Object.entries(savedPresets)) {
            console.log(`${key}:`, {
                name: value.name,
                lastModified: value.lastModified,
                settingsCount: Object.keys(value.settings).length,
                sampleSettings: {
                    bgcolor: value.settings.bgcolor,
                    size1: value.settings.size1,
                    recog: value.settings.recog,
                    trans: value.settings.trans
                }
            });
        }
        console.log('=== Preajuste actual ===', currentPreset);
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
    window.debugPresets = debugPresets;
    
    // Preajustesé¸æŠçŠ¶æ…‹ã‚’ãƒ‡ãƒãƒƒã‚°ã™ã‚‹é–¢æ•°
    function debugPresetSelection() {
        console.log('=== DepuraciÃ³n de selecciÃ³n de preajuste ===');
        console.log('Variable currentPreset:', currentPreset);
        console.log('localStorage.selectedPreset:', localStorage.getItem('selectedPreset'));
        
        const presetSelect = document.getElementById('presetSelect');
        if (presetSelect) {
            console.log('Valor actual del menÃº desplegable:', presetSelect.value);
            console.log('OpciÃ³n seleccionada en el menÃº desplegable:', presetSelect.options[presetSelect.selectedIndex]?.text);
        } else {
            console.log('MenÃº desplegable no encontrado');
        }
    }
    
    window.debugPresetSelection = debugPresetSelection;
    
    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®è‡ªå‹•ç§»è¡Œé–¢æ•°
    function migrateExistingUserSettings() {
        console.log('=== Iniciando verificaciÃ³n de migraciÃ³n de configuraciÃ³n de usuario existente ===');
        
        // æ—§è¨­å®šã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€åˆã«ç¢ºèªï¼‰
        const oldConfig = localStorage.getItem('jimakuChan_config');
        const migrationFlag = localStorage.getItem('jimakuChan_migrated');
        
        console.log('Estado de migraciÃ³n:', {
            oldConfig: !!oldConfig,
            migrationFlag: migrationFlag,
            oldConfigLength: oldConfig ? oldConfig.length : 0
        });
        
        // æ—§è¨­å®šãŒãªã„å ´åˆã®å‡¦ç†
        if (!oldConfig) {
            console.log('Sin configuraciÃ³n antigua - MigraciÃ³n no necesaria');
            if (migrationFlag !== 'true') {
                localStorage.setItem('jimakuChan_migrated', 'true');
                console.log('Bandera de migraciÃ³n establecida para nuevo usuario');
            }
            return;
        }
        
        // ç§»è¡Œæ¸ˆã¿ãƒ•ãƒ©ã‚°ãŒã‚ã‚‹ãŒæ—§è¨­å®šã‚‚æ®‹ã£ã¦ã„ã‚‹å ´åˆï¼ˆç§»è¡Œå¤±æ•—ã®å¯èƒ½æ€§ï¼‰
        if (migrationFlag === 'true' && oldConfig) {
            console.warn('âš ï¸ Bandera de migraciÃ³n presente pero configuraciÃ³n antigua aÃºn existe - Ejecutando remigraciÃ³n');
            console.log('Esta situaciÃ³n puede indicar una migraciÃ³n fallida');
        }
        
        try {
            const oldSettings = JSON.parse(oldConfig);
            console.log('ConfiguraciÃ³n antigua encontrada:', Object.keys(oldSettings).length + ' Ã­tems');
            console.log('Muestra de configuraciÃ³n antigua:', {
                bgcolor: oldSettings.bgcolor,
                size1: oldSettings.size1,
                recog: oldSettings.recog,
                trans: oldSettings.trans
            });
            
            // ã€Œé¸æŠã—ã¦ãã ã•ã„ã€Preajustesã®æ—¢å­˜ãƒã‚§ãƒƒã‚¯
            const savedPresets = JSON.parse(localStorage.getItem('jimakuChan_presets') || '{}');
            
            if (savedPresets['default'] && savedPresets['default'].settings) {
                console.log('Preajuste "Selecciona" ya existe - Omitiendo migraciÃ³n de configuraciÃ³n antigua');
                // ç§»è¡Œæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                localStorage.setItem('jimakuChan_migrated', 'true');
                return;
            }
            
            // æ—§è¨­å®šã‚’ã€Œé¸æŠã—ã¦ãã ã•ã„ã€Preajustesã«ç§»è¡Œ
            console.log('Iniciando migraciÃ³n de configuraciÃ³n antigua a preajuste "Selecciona"');
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆPreajustesã®è¨­å®šé …ç›®ã«åˆã‚ã›ã¦ç§»è¡Œ
            const migratedSettings = {};
            
            // è¨­å®šé …ç›®ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆconfig_valuesã¨å®Œå…¨ä¸€è‡´ï¼‰
            const settingKeys = [
                'gas_key', 'textAlign', 'v_align', 'whiteSpace', 'bgcolor', 'frame_height',
                'recog', 'size1', 'weight1', 'color1', 'st_color1', 'st_width1',
                'trans', 'size2', 'weight2', 'color2', 'st_color2', 'st_width2',
                'trans2', 'size3', 'weight3', 'color3', 'st_color3', 'st_width3',
                'trans3', 'size4', 'weight4', 'color4', 'st_color4', 'st_width4',
                'timer', 'short_pause', 'bouyomi', 'anti_sexual',
                'speech_text_font_selector', 'trans_text_font_selector', 
                'trans_text2_font_selector', 'trans_text3_font_selector',
                'speech_text_system_font', 'trans_text_system_font',
                'trans_text2_system_font', 'trans_text3_system_font'
            ];
            
            // æ—§è¨­å®šã‹ã‚‰æ–°è¨­å®šã«ã‚³ãƒ”ãƒ¼ï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
            console.log('=== Estado de migraciÃ³n por Ã­tem de configuraciÃ³n ===');
            let migratedCount = 0;
            let skippedCount = 0;
            
            settingKeys.forEach(key => {
                if (oldSettings.hasOwnProperty(key)) {
                    migratedSettings[key] = oldSettings[key];
                    console.log(`âœ… ${key}: "${oldSettings[key]}" -> Migrado`);
                    migratedCount++;
                } else {
                    console.log(`âš ï¸ ${key}: No existe en configuraciÃ³n antigua`);
                    skippedCount++;
                }
            });
            
            console.log(`MigraciÃ³n completada: ${migratedCount} Ã­tems, Omitidos: ${skippedCount} Ã­tems`);
            
            // Fuenteè¨­å®šã®ç§»è¡Œï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œï¼‰
            if (oldSettings.speech_text_font && !migratedSettings.speech_text_font_selector) {
                migratedSettings.speech_text_font_selector = oldSettings.speech_text_font;
            }
            if (oldSettings.trans_text_font && !migratedSettings.trans_text_font_selector) {
                migratedSettings.trans_text_font_selector = oldSettings.trans_text_font;
            }
            if (oldSettings.trans_text2_font && !migratedSettings.trans_text2_font_selector) {
                migratedSettings.trans_text2_font_selector = oldSettings.trans_text2_font;
            }
            if (oldSettings.trans_text3_font && !migratedSettings.trans_text3_font_selector) {
                migratedSettings.trans_text3_font_selector = oldSettings.trans_text3_font;
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ä¸è¶³é …ç›®ã‚’è£œå®Œ
            console.log('=== Procesamiento de complemento con valores por defecto ===');
            const defaultSettings = defaultPresets['default']?.settings || {};
            
            // åŸºæœ¬çš„ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            const basicDefaults = {
                textAlign: 'center',
                v_align: 'top',
                bgcolor: '#00ff00',
                whiteSpace: '',
                recog: 'ja',
                size1: '25', weight1: '900', color1: '#ffffff', st_color1: '#000000', st_width1: '6',
                trans: 'none',
                size2: '25', weight2: '900', color2: '#ffffff', st_color2: '#000000', st_width2: '6',
                trans2: 'none',
                size3: '25', weight3: '900', color3: '#ffffff', st_color3: '#000000', st_width3: '6',
                trans3: 'none',
                size4: '25', weight4: '900', color4: '#ffffff', st_color4: '#000000', st_width4: '6',
                timer: '7000',
                short_pause: '750',
                bouyomi: false,
                anti_sexual: false,
                speech_text_font_selector: 'M PLUS Rounded\\ 1c',
                trans_text_font_selector: 'M PLUS Rounded\\ 1c',
                trans_text2_font_selector: 'M PLUS Rounded\\ 1c',
                trans_text3_font_selector: 'M PLUS Rounded\\ 1c',
                speech_text_system_font: '',
                trans_text_system_font: '',
                trans_text2_system_font: '',
                trans_text3_system_font: '',
                frame_height: '30%',
                gas_key: ''
            };
            
            let defaultCount = 0;
            settingKeys.forEach(key => {
                if (!migratedSettings.hasOwnProperty(key)) {
                    // ã¾ãšdefaultPresetsã‹ã‚‰è©¦ã™
                    if (defaultSettings.hasOwnProperty(key)) {
                        migratedSettings[key] = defaultSettings[key];
                        console.log(`ğŸ“ ${key}: Complementado desde preajuste por defecto -> "${defaultSettings[key]}"`);
                    }
                    // æ¬¡ã«basicDefaultsã‹ã‚‰è©¦ã™
                    else if (basicDefaults.hasOwnProperty(key)) {
                        migratedSettings[key] = basicDefaults[key];
                        console.log(`ğŸ“ ${key}: Complementado con valor por defecto bÃ¡sico -> "${basicDefaults[key]}"`);
                    }
                    else {
                        console.log(`âŒ ${key}: Sin valor por defecto`);
                    }
                    defaultCount++;
                }
            });
            
            console.log(`Complemento con valores por defecto: ${defaultCount} Ã­tems`);
            
            // ã€Œé¸æŠã—ã¦ãã ã•ã„ã€Preajustesã¨ã—ã¦ä¿å­˜
            savedPresets['default'] = {
                name: 'Selecciona',
                settings: migratedSettings,
                lastModified: new Date().toISOString(),
                migratedFrom: 'jimakuChan_config'
            };
            
            localStorage.setItem('jimakuChan_presets', JSON.stringify(savedPresets));
            
            // ç§»è¡Œå¾Œæ¤œè¨¼ï¼šå®Ÿéš›ã«ä¿å­˜ã•ã‚ŒãŸã‹ç¢ºèª
            console.log('=== VerificaciÃ³n posterior a la migraciÃ³n ===');
            const verifyPresets = JSON.parse(localStorage.getItem('jimakuChan_presets') || '{}');
            if (verifyPresets.default && verifyPresets.default.settings) {
                console.log('âœ… VerificaciÃ³n de guardado de preajuste "Selecciona" OK');
                console.log('NÃºmero de Ã­tems de configuraciÃ³n guardados:', Object.keys(verifyPresets.default.settings).length);
                
                // é‡è¦ãªè¨­å®šé …ç›®ã‚’å€‹åˆ¥ç¢ºèª
                const verifySettings = verifyPresets.default.settings;
                const criticalKeys = ['bgcolor', 'size1', 'recog', 'gas_key', 'timer'];
                console.log('=== VerificaciÃ³n de Ã­tems de configuraciÃ³n importantes ===');
                criticalKeys.forEach(key => {
                    console.log(`${key}: "${verifySettings[key] || 'undefined'}"`);
                });
                
            } else {
                console.error('âŒ Error al guardar preajuste "Selecciona"');
            }
            
            console.log('âœ… MigraciÃ³n de configuraciÃ³n completada');
            console.log('NÃºmero de Ã­tems de configuraciÃ³n migrados:', Object.keys(migratedSettings).length);
            
            // ç§»è¡ŒæˆåŠŸæ™‚ã®ã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
            localStorage.setItem('jimakuChan_migrated', 'true');
            
            // æ—§è¨­å®šã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã«ãƒªãƒãƒ¼ãƒ ï¼ˆå‰Šé™¤ã¯ã—ãªã„ï¼‰
            localStorage.setItem('jimakuChan_config_backup', oldConfig);
            console.log('ConfiguraciÃ³n antigua guardada como respaldo: jimakuChan_config_backup');
            
            // ç§»è¡Œå®Œäº†å¾Œã€æ—§è¨­å®šã‚’å‰Šé™¤ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ä¿æŒï¼‰
            localStorage.removeItem('jimakuChan_config');
            console.log('âœ… ConfiguraciÃ³n antigua (jimakuChan_config) eliminada (migraciÃ³n completada)');
            console.log('âœ… Toda la configuraciÃ³n ahora se gestiona mediante jimakuChan_presets');
            
        } catch (error) {
            console.error('âŒ Error en migraciÃ³n de configuraciÃ³n:', error);
            console.error('MigraciÃ³n fallida. La configuraciÃ³n antigua y la bandera se mantienen');
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç§»è¡Œæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ãªã„ï¼ˆå†è©¦è¡Œå¯èƒ½ã«ã™ã‚‹ï¼‰
            // localStorage.setItem('jimakuChan_migrated', 'true'); // ã“ã®è¡Œã‚’å‰Šé™¤
        }
    }
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç§»è¡ŒçŠ¶æ³ç¢ºèªé–¢æ•°
    function debugMigrationStatus() {
        console.log('=== DepuraciÃ³n de estado de migraciÃ³n ===');
        const oldConfig = localStorage.getItem('jimakuChan_config');
        const migrationFlag = localStorage.getItem('jimakuChan_migrated');
        const backup = localStorage.getItem('jimakuChan_config_backup');
        const presets = localStorage.getItem('jimakuChan_presets');
        
        console.log('ConfiguraciÃ³n antigua (jimakuChan_config):', !!oldConfig, oldConfig ? oldConfig.length + 'caracteres' : 'Ninguno');
        console.log('Bandera de migraciÃ³n (jimakuChan_migrated):', migrationFlag);
        console.log('Respaldo (jimakuChan_config_backup):', !!backup);
        console.log('Preajustes (jimakuChan_presets):', !!presets);
        
        if (presets) {
            const presetsData = JSON.parse(presets);
            console.log('Preajuste "Selecciona":', !!presetsData.default);
            if (presetsData.default) {
                console.log('InformaciÃ³n de origen de migraciÃ³n:', presetsData.default.migratedFrom || 'Ninguno');
                console.log('NÃºmero de Ã­tems de configuraciÃ³n:', Object.keys(presetsData.default.settings || {}).length);
            }
        }
        
        return {
            hasOldConfig: !!oldConfig,
            migrationFlag: migrationFlag,
            hasBackup: !!backup,
            hasPresets: !!presets
        };
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
    window.debugMigrationStatus = debugMigrationStatus;
    
    // å¼·åˆ¶å†ç§»è¡Œé–¢æ•°ï¼ˆãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨ï¼‰
    function forceMigration() {
        console.log('=== Ejecutando remigraciÃ³n forzada ===');
        localStorage.removeItem('jimakuChan_migrated');
        console.log('Bandera de migraciÃ³n eliminada');
        console.log('PrecauciÃ³n: Esta operaciÃ³n migrarÃ¡ la configuraciÃ³n antigua (jimakuChan_config)');
        console.log('al preajuste "Selecciona" si existe, y la configuraciÃ³n antigua serÃ¡ eliminada');
        migrateExistingUserSettings();
        
        // ç§»è¡Œå¾Œã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æ–°ã—ã„è¨­å®šã‚’åæ˜ 
        setTimeout(() => {
            console.log('Recargando pÃ¡gina despuÃ©s de la migraciÃ³n...');
            location.reload();
        }, 1000);
    }
    
    window.forceMigration = forceMigration;
    
    // frame_heightï¼ˆè¨­å®šç”»é¢Mostrar/éMostrarï¼‰ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
    function applyFrameHeight() {
        const frameHeightElement = document.getElementById('frame_height');
        const iframe = document.getElementById('asr_frame');
        const body = document.body;
        
        if (frameHeightElement && iframe) {
            const frameHeight = frameHeightElement.value || '30%';
            iframe.style.height = frameHeight;
            
            console.log('frame_height aplicado:', frameHeight);
            
            if (frameHeight === '100%') {
                body.style.overflow = 'hidden';  // ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ã™ã‚‹
            } else {
                body.style.overflow = 'auto';  // ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            }
        }
    }
    
    // PreajustesåˆæœŸåŒ–ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œï¼‰
    function initializePresets() {
        console.log('=== InicializaciÃ³n de preajustes iniciada ===');
        const presetSelect = document.getElementById('presetSelect');
        
        if (!presetSelect) {
            console.error('Cuadro de selecciÃ³n de preajustes no encontrado');
            return;
        }
        
        // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®è‡ªå‹•ç§»è¡Œå‡¦ç†
        migrateExistingUserSettings();
        
        // localStorageã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸPreajustesé¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
        const savedSelectedPreset = localStorage.getItem('selectedPreset');
        console.log('Estado de selecciÃ³n de preajuste guardado:', savedSelectedPreset);
        
        if (savedSelectedPreset) {
            currentPreset = savedSelectedPreset;
        } else {
            currentPreset = 'default'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        }
        
        console.log('currentPreset restaurado:', currentPreset);
        
        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«å€¤ã‚’è¨­å®š
        presetSelect.value = currentPreset;
        
        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ãŒæ­£ã—ãè¨­å®šã•ã‚ŒãŸã‹ç¢ºèª
        console.log('Valor despuÃ©s de configurar el menÃº desplegable:', presetSelect.value);
        
        // å€¤ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®å¯¾å‡¦
        if (presetSelect.value !== currentPreset) {
            console.warn('Error al configurar menÃº desplegable, configurando manualmente:', currentPreset);
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            const options = Array.from(presetSelect.options);
            const targetOption = options.find(option => option.value === currentPreset);
            if (targetOption) {
                targetOption.selected = true;
                console.log('ConfiguraciÃ³n manual completada');
            } else {
                console.error('Preajuste especificado no encontrado:', currentPreset);
                currentPreset = 'default';
                presetSelect.value = currentPreset;
            }
        }
        
        // ã€Œé¸æŠã—ã¦ãã ã•ã„ã€ã®å ´åˆã¯äº‹å‰ã«ä¿å­˜æ¸ˆã¿è¨­å®šã‚’å¾©å…ƒ
        if (currentPreset === 'default') {
            console.log('InicializaciÃ³n de "Selecciona" - Verificando configuraciÃ³n guardada');
            const savedPresets = JSON.parse(localStorage.jimakuChan_presets || '{}');
            
            if (savedPresets['default'] && savedPresets['default'].settings) {
                console.log('Restaurando previamente configuraciÃ³n "Selecciona" guardada');
                const savedSettings = savedPresets['default'].settings;
                
                // è¨­å®šã‚’UIã«äº‹å‰é©ç”¨
                for (const [key, value] of Object.entries(savedSettings)) {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value;
                        } else {
                            element.value = value;
                        }
                    }
                }
            }
        }
        
        // å°‘ã—é…å»¶ã—ã¦Preajustesã‚’é©ç”¨ï¼ˆDOMæ§‹ç¯‰å®Œäº†ã‚’å¾…ã¤ï¼‰
        setTimeout(function() {
            console.log('Ejecutando loadPreset dentro de initializePresets');
            loadPreset();
        }, 50);
    }
    
    // Mostrarè¨­å®šã‚’æ›´æ–°ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ•°å€¤Mostrarï¼‰
    function updateVisualSettings() {
        console.log('Actualizando visualizaciÃ³n de valores de deslizadores...');
        
        // å„ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤Mostrarã‚’æ›´æ–°
        for (let i = 1; i <= 4; i++) {
            const sizeElement = document.getElementById('size' + i);
            const weightElement = document.getElementById('weight' + i);
            const stWidthElement = document.getElementById('st_width' + i);
            
            const sizeViewElement = document.getElementById('text_size_view' + i);
            const weightViewElement = document.getElementById('text_weight_view' + i);
            const stSizeViewElement = document.getElementById('text_st_size_view' + i);
            
            if (sizeElement && sizeViewElement) {
                sizeViewElement.innerHTML = sizeElement.value;
                console.log('VisualizaciÃ³n de size' + i + ' actualizada:', sizeElement.value);
            }
            if (weightElement && weightViewElement) {
                weightViewElement.innerHTML = weightElement.value;
                console.log('VisualizaciÃ³n de weight' + i + ' actualizada:', weightElement.value);
            }
            if (stWidthElement && stSizeViewElement) {
                stSizeViewElement.innerHTML = stWidthElement.value;
                console.log('VisualizaciÃ³n de st_width' + i + ' actualizada:', stWidthElement.value);
            }
        }
        
        // è¡Œé–“è¨­å®šã®Mostrarã‚’æ›´æ–°
        for (let i = 1; i <= 3; i++) {
            const lineSpacingElement = document.getElementById('line_spacing_' + i);
            const lineSpacingValueElement = document.getElementById('line_spacing_' + i + '_value');
            
            if (lineSpacingElement && lineSpacingValueElement) {
                lineSpacingValueElement.textContent = lineSpacingElement.value + 'px';
                console.log('VisualizaciÃ³n de line_spacing_' + i + ' actualizada:', lineSpacingElement.value + 'px');
            }
        }
        
        console.log('ActualizaciÃ³n de visualizaciÃ³n de valores de deslizadores completada');
    }
</script>

<!-- # éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–æ©Ÿèƒ½ã€€############################ -->
<!-- éŸ³é‡Mostraræ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆéŸ³å£°èªè­˜ãƒ‡ãƒã‚¤ã‚¹ã¨ã®ä¸ä¸€è‡´ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ··ä¹±é˜²æ­¢ã®ãŸã‚ï¼‰ -->
<script>
    // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ç”¨ã®å¤‰æ•°ï¼ˆç„¡åŠ¹åŒ–ï¼‰
    // let audioContext = null;
    // let analyser = null;
    // let microphone = null;
    // let dataArray = null;
    
    // Web Speech APIã¯ãƒ‡ãƒã‚¤ã‚¹é¸æŠã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„ãŸã‚ã€ã“ã®æ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–
    function refreshAudioDevices() {
        console.log('Debido a las limitaciones de Web Speech API, la selecciÃ³n de dispositivos de audio no estÃ¡ disponible');
        console.log('Solo se utilizarÃ¡ el dispositivo de entrada de audio predeterminado');
        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆéŸ³å£°èªè­˜ãƒ‡ãƒã‚¤ã‚¹ã¨ã®ä¸ä¸€è‡´ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ··ä¹±é˜²æ­¢ã®ãŸã‚ï¼‰
        // startAudioLevelMonitoring();
    }
    
    // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã‚’é–‹å§‹ï¼ˆæ—¢å®šãƒ‡ãƒã‚¤ã‚¹ã®ã¿ä½¿ç”¨ï¼‰
    async function startAudioLevelMonitoring() {
        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆéŸ³å£°èªè­˜ãƒ‡ãƒã‚¤ã‚¹ã¨ã®ä¸ä¸€è‡´ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ··ä¹±é˜²æ­¢ã®ãŸã‚ï¼‰
        console.log('La funciÃ³n de monitoreo de nivel de audio estÃ¡ deshabilitada');
        /*
        try {
            // Web Speech APIã®åˆ¶é™ã«ã‚ˆã‚Šã€å¸¸ã«æ—¢å®šãƒ‡ãƒã‚¤ã‚¹ã‚’ä½¿ç”¨
            // autoGainControlã‚’falseã«è¨­å®šã—ã¦è‡ªå‹•ã‚²ã‚¤ãƒ³èª¿æ•´ã‚’ç„¡åŠ¹åŒ–
            const constraints = { 
                audio: {
                    autoGainControl: false,
                    noiseSuppression: true,
                    echoCancellation: true
                }
            };
                
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            microphone.connect(analyser);
            
            updateAudioLevel();
            
        } catch (error) {
            console.error('Error al iniciar el monitoreo de nivel de audio:', error);
        }
        */
    }
    
    // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã‚’åœæ­¢
    function stopAudioLevelMonitoring() {
        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆéŸ³å£°èªè­˜ãƒ‡ãƒã‚¤ã‚¹ã¨ã®ä¸ä¸€è‡´ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ··ä¹±é˜²æ­¢ã®ãŸã‚ï¼‰
        console.log('La funciÃ³n de detener el monitoreo de nivel de audio estÃ¡ deshabilitada');
        /*
        if (microphone) {
            microphone.disconnect();
            microphone = null;
        }
        if (audioContext) {
            audioContext.close();
            audioContext = null;
        }
        document.getElementById('audioLevelCover').style.width = '100%';
        document.getElementById('audioLevelText').textContent = '0%';
        */
    }
    
    // éŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’æ›´æ–°ï¼ˆç„¡åŠ¹åŒ–ï¼‰
    function updateAudioLevel() {
        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆéŸ³å£°èªè­˜ãƒ‡ãƒã‚¤ã‚¹ã¨ã®ä¸ä¸€è‡´ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ··ä¹±é˜²æ­¢ã®ãŸã‚ï¼‰
        return;
        /*
        if (!analyser || !dataArray) return;
        
        analyser.getByteFrequencyData(dataArray);
        
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            sum += dataArray[i];
        }
        const average = sum / dataArray.length;
        const level = Math.min(100, (average / 128) * 100);
        
        // ã‚«ãƒãƒ¼ã®å¹…ã‚’èª¿æ•´ï¼ˆãƒ¬ãƒ™ãƒ«ãŒé«˜ã„ã»ã©ã‚«ãƒãƒ¼ãŒç‹­ããªã‚‹ï¼‰
        document.getElementById('audioLevelCover').style.width = (100 - level) + '%';
        document.getElementById('audioLevelText').textContent = Math.round(level) + '%';
        
        // å¸¸ã«æ›´æ–°ã‚’ç¶šã‘ã‚‹
        requestAnimationFrame(updateAudioLevel);
        */
    }
    
    // Web Speech APIã®åˆ¶é™ã«ã‚ˆã‚Šã€ãƒ‡ãƒã‚¤ã‚¹é¸æŠæ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // Font Access APIå¯¾å¿œçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦Mostrarï¼ˆç„¡åŠ¹åŒ–ï¼‰
        // checkFontAPIStatus();
        
        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆéŸ³å£°èªè­˜ãƒ‡ãƒã‚¤ã‚¹ã¨ã®ä¸ä¸€è‡´ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ··ä¹±é˜²æ­¢ã®ãŸã‚ï¼‰
        // refreshAudioDevices();
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ã‚’ç¢ºå®Ÿã«ç™»éŒ²
        setupMessageListener();
        
        // ã‚·ã‚¹ãƒ†ãƒ Fuenteé¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆæœŸåŒ–
        setTimeout(initializeFontSelectors, 100);
        
        // PreajustesåˆæœŸåŒ–ï¼ˆä¿å­˜æ¸ˆã¿è¨­å®šå¾©å…ƒï¼‰
        setTimeout(initializePresets, 200);
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«è¨­å®šã‚’ç¢ºå®Ÿã«åæ˜ 
        setTimeout(applyInitialSettings, 800);
        
        // ã•ã‚‰ã«ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã€è¿½åŠ ã®ã‚¿ã‚¤ãƒãƒ¼ã§ã‚‚å®Ÿè¡Œ
        setTimeout(applyInitialSettings, 1500);
    });
</script>

<!-- # Contador de traduccioneså–å¾—ã€€############################ -->
<script>
    function getTranslationCount() {
        var iframe = document.getElementById('asr_frame');
        var transCount = iframe.contentWindow.document.getElementById('translationCount').innerHTML;
        if(transCount == ''){
            transCount = '[Â¡AquÃ­ aparecerÃ¡ el nÃºmero de veces!]';
        }
        return transCount;
    }

    // 1ç§’ã”ã¨ã«ç¿»è¨³ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
    setInterval(function() {
        document.getElementById('displayTransCount').innerHTML = getTranslationCount();
    }, 1000);
</script>

<!-- # iframeã®é«˜ã•ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã€€############################ -->
<script>
    function toggleIframeHeight() {
        console.log("toggleIframeHeight");
        var iframe = document.getElementById('asr_frame');
        var body = document.body;

        // ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«PosiciÃ³nã‚’ä¸€ç•ªArribaã«Restaurar
        window.scrollTo(0, 0);

        if (iframe.style.height === '100%') {
            iframe.style.height = '30%';
            body.style.overflow = 'auto';  // ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        } else {
            iframe.style.height = '100%';
            body.style.overflow = 'hidden';  // ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ã™ã‚‹
        }

        document.getElementById('frame_height').value = iframe.style.height;
        updateOptionValues();
    }
</script>

<!-- iframeã®é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ã™ã‚‹ -->
<script>
    window.addEventListener('load', function() {
        var iframe = document.getElementById('asr_frame');
        
        // iframeã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
        iframe.addEventListener('load', function() {
            try {
                var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                iframeDoc.addEventListener('click', function() {
                    toggleIframeHeight();
                });
                
                // iframeèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ç¿»è¨³æ–¹æ³•ã‚’ç¢ºå®Ÿã«é€ä¿¡
                setTimeout(() => {
                    updateTranslationMethodInIframe();
                    console.log('Enviando mÃ©todo de traducciÃ³n despuÃ©s de cargar iframe');
                    
                    // Chromeç¿»è¨³ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã‚’ç¢ºèª
                    const chromeRadio = document.getElementById('translationMethodChrome');
                    if (chromeRadio && chromeRadio.checked) {
                        console.log('Confirmando selecciÃ³n de traducciÃ³n Chrome - Verificando inicio del temporizador');
                        setTimeout(() => {
                            updateTranslationMethodInIframe('chrome');
                        }, 1000);
                    }
                }, 500);
            } catch (e) {
                console.error('Error al acceder al iframe:', e);
            }
        });
        
        // ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«è¨­å®šã‚’ç¢ºå®Ÿã«åæ˜ 
        setTimeout(applyInitialSettings, 1000);
    });
</script>

<!-- # PreajustesåˆæœŸåŒ–ï¼ˆæœ€çµ‚å®Ÿè¡Œï¼‰ ###################### -->
<script>
    // ãƒšãƒ¼ã‚¸å®Œå…¨èª­ã¿è¾¼ã¿å¾Œã«PreajustesåˆæœŸåŒ–ã‚’å®Ÿè¡Œ
    window.addEventListener('load', function() {
        console.log('Carga completa de pÃ¡gina - Ejecutando inicializaciÃ³n de preajustes');
        
        // å°‘ã—é…å»¶ã—ã¦ç¢ºå®Ÿã«å®Ÿè¡Œ
        setTimeout(function() {
            console.log('Iniciando inicializaciÃ³n de preajustes');
            
            const presetSelect = document.getElementById('presetSelect');
            if (!presetSelect) {
                console.error('Cuadro de selecciÃ³n de preajustes no encontrado');
                return;
            }
            
            // localStorageã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸPreajustesé¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
            const savedSelectedPreset = localStorage.getItem('selectedPreset');
            console.log('Estado de selecciÃ³n de preajuste guardado:', savedSelectedPreset);
            
            if (savedSelectedPreset) {
                console.log('Restaurando preajuste guardado:', savedSelectedPreset);
                presetSelect.value = savedSelectedPreset;
                
                // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ãŒæ­£ã—ãè¨­å®šã•ã‚ŒãŸã‹ç¢ºèª
                if (presetSelect.value === savedSelectedPreset) {
                    console.log('RestauraciÃ³n del menÃº desplegable exitosa:', savedSelectedPreset);
                    // Preajustesã‚’å®Ÿéš›ã«èª­ã¿è¾¼ã‚€
                    const event = new Event('change');
                    presetSelect.dispatchEvent(event);
                } else {
                    console.error('Error en restauraciÃ³n del menÃº desplegable:', savedSelectedPreset, 'Valor actual:', presetSelect.value);
                }
            } else {
                console.log('Sin preajuste guardado, usando valor por defecto');
                presetSelect.value = 'default';
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆPreajustesã‚’èª­ã¿è¾¼ã‚€
                const event = new Event('change');
                presetSelect.dispatchEvent(event);
            }
        }, 500);
    });
    
    // iframeã‹ã‚‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰çŠ¶æ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
    window.addEventListener('message', function(event) {
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å‡¦ç†
        if (event.data && event.data.type === 'modelDownloadRequired') {
            // éŸ³å£°èªè­˜å¾Œã®ç¿»è¨³ã§ãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ãªå ´åˆ
            console.log('Se requiere descarga de modelo para traducciÃ³n despuÃ©s del reconocimiento de voz:', event.data);
            
            // æ—¢ã«pendingModelsã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            const exists = pendingModels.some(m => 
                m.sourceLang === event.data.sourceLang && 
                m.targetLang === event.data.targetLang
            );
            
            if (!exists) {
                // pendingModelsã«è¿½åŠ 
                pendingModels.push({
                    sourceLang: event.data.sourceLang,
                    targetLang: event.data.targetLang,
                    translationNum: event.data.translationNum
                });
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’Mostrar
                const modelArea = document.getElementById('modelDownloadArea');
                const btn = document.getElementById('preloadModelBtn');
                
                if (modelArea && btn) {
                    // æœ€åˆã®ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’Mostrar
                    const firstModel = pendingModels[0];
                    const sourceDisplayName = getLanguageDisplayName(firstModel.sourceLang);
                    const targetDisplayName = getLanguageDisplayName(firstModel.targetLang);
                    
                    btn.textContent = `ğŸ“¥ Descargar modelo ${sourceDisplayName}â†’${targetDisplayName}`;
                    btn.disabled = false;
                    btn.style.backgroundColor = '#4CAF50';
                    btn.style.color = 'white';
                    
                    modelArea.style.display = 'block';
                    
                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰çŠ¶æ³ã‚‚Mostrar
                    const statusArea = document.getElementById('downloadStatusArea');
                    const statusText = document.getElementById('downloadStatusText');
                    if (statusArea && statusText) {
                        statusText.innerHTML = `âš ï¸ Se requiere modelo para traducciÃ³n despuÃ©s del reconocimiento de voz`;
                        statusArea.style.display = 'block';
                        statusArea.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%)';
                        
                        // 5ç§’å¾Œã«éMostrar
                        setTimeout(() => {
                            statusArea.style.display = 'none';
                        }, 5000);
                    }
                }
                
                updateQueueStatus();
            }
        } else if (event.data && event.data.type === 'downloadStatus') {
            const statusArea = document.getElementById('downloadStatusArea');
            const statusText = document.getElementById('downloadStatusText');
            
            if (statusArea && statusText) {
                if (event.data.status === 'downloading') {
                    // é€²æ—ç‡ãŒã‚ã‚‹å ´åˆã¯Mostrar
                    const progressText = event.data.progress !== undefined 
                        ? `ğŸ”„ ${event.data.message}` 
                        : 'ğŸ”„ ' + event.data.message;
                    statusText.innerHTML = progressText;
                    statusArea.style.display = 'block';
                    
                    // é€²æ—ç‡ã«å¿œã˜ã¦èƒŒæ™¯è‰²ã‚’å¤‰åŒ–
                    if (event.data.progress !== undefined) {
                        const progress = event.data.progress;
                        // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§é€²æ—ã‚’è¡¨ç¾
                        statusArea.style.background = `linear-gradient(90deg, #ffa726 ${progress}%, #ffe0b2 ${progress}%)`;
                    } else {
                        statusArea.style.background = 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)';
                    }
                } else if (event.data.status === 'completed') {
                    statusText.innerHTML = 'âœ… ' + event.data.message;
                    statusArea.style.display = 'block';
                    statusArea.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                    // 3ç§’å¾Œã«éMostrar
                    setTimeout(() => {
                        statusArea.style.display = 'none';
                    }, 3000);
                } else if (event.data.status === 'error') {
                    statusText.innerHTML = 'âŒ ' + event.data.message;
                    statusArea.style.display = 'block';
                    statusArea.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
                    // 5ç§’å¾Œã«éMostrar
                    setTimeout(() => {
                        statusArea.style.display = 'none';
                    }, 5000);
                }
            }
        }
    });
    
    // Chrome Translation API äº‹å‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
    let currentTranslationPair = null; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹è¨€èªãƒšã‚¢
    let pendingModels = []; // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾…ã¡ã®ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ
    
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾…ã¡ãƒ¢ãƒ‡ãƒ«æ•°ã®Mostrarã‚’æ›´æ–°
    function updateQueueStatus() {
        const queueStatus = document.getElementById('modelQueueStatus');
        if (queueStatus) {
            if (pendingModels.length > 0) {
                queueStatus.style.display = 'inline-block';
                queueStatus.textContent = `ğŸ“¦ Restantes: ${pendingModels.length}`;
                
                // å€‹æ•°ã«ã‚ˆã£ã¦è‰²ã‚’å¤‰ãˆã‚‹
                if (pendingModels.length === 1) {
                    queueStatus.style.background = 'rgba(76, 175, 80, 0.1)';
                    queueStatus.style.color = '#4CAF50';
                } else if (pendingModels.length <= 3) {
                    queueStatus.style.background = 'rgba(255, 193, 7, 0.1)';
                    queueStatus.style.color = '#f57c00';
                } else {
                    queueStatus.style.background = 'rgba(244, 67, 54, 0.1)';
                    queueStatus.style.color = '#d32f2f';
                }
            } else {
                queueStatus.style.display = 'none';
            }
        }
    }
    
    // å…¨ã¦ã®ç¿»è¨³ãƒ¢ãƒ‡ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆéŸ³å£°èªè­˜è¨€èªå¤‰æ›´æ™‚ç”¨ï¼‰
    function checkAllTranslationModels() {
        // éŸ³å£°èªè­˜è¨€èªå¤‰æ›´æ™‚ã¯å¾…æ©Ÿãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
        pendingModels = [];
        updateQueueStatus(); // ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        
        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        const modelBtn = document.getElementById('preloadModelBtn');
        const modelStatus = document.getElementById('modelStatusText');
        if (modelBtn) {
            modelBtn.disabled = false;
            modelBtn.style.background = '#ff6b6b';
        }
        if (modelStatus) {
            modelStatus.textContent = '';
            modelStatus.style.color = '#333';
        }
        
        // ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã€å„ãƒã‚§ãƒƒã‚¯ã‚’try-catchã§å›²ã‚€
        try {
            checkTranslationModel(1);
        } catch (error) {
            console.error('Error al verificar modelo de traducciÃ³n 1:', error);
        }
        try {
            checkTranslationModel(2);
        } catch (error) {
            console.error('Error al verificar modelo de traducciÃ³n 2:', error);
        }
        try {
            checkTranslationModel(3);
        } catch (error) {
            console.error('Error al verificar modelo de traducciÃ³n 3:', error);
        }
    }
    
    function checkTranslationModel(transNum = 1, event = null) {
        // Chrome Translation APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿
        if (!('Translator' in self)) return;
        
        const recogSelect = document.getElementById('recog');
        let transSelectId = 'trans';
        if (transNum === 2) transSelectId = 'trans2';
        if (transNum === 3) transSelectId = 'trans3';
        
        const transSelect = document.getElementById(transSelectId);
        const modelArea = document.getElementById('modelDownloadArea');
        const modelBtn = document.getElementById('preloadModelBtn');
        const modelStatus = document.getElementById('modelStatusText');
        
        if (!transSelect) return;
        
        const sourceLang = recogSelect.value;
        const targetLang = transSelect.value;
        
        // ç¿»è¨³è¨€èªãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (targetLang === 'none') {
            currentTranslationPair = null;
            return;
        }
        
        // åŒä¸€è¨€èªã®å ´åˆã‚‚ä½•ã‚‚ã—ãªã„ï¼ˆç¿»è¨³ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ï¼‰
        if (sourceLang === targetLang) {
            return;
        }
        
        // iframeå†…ã®chromeTranslatorã‚’å–å¾—
        const iframe = document.getElementById('asr_frame');
        if (!iframe || !iframe.contentWindow || !iframe.contentWindow.chromeTranslator) {
            console.log('Chrome Translator no preparado');
            return;
        }
        
        const translator = iframe.contentWindow.chromeTranslator;
        
        // è¨€èªã‚³ãƒ¼ãƒ‰ã‚’æ­£è¦åŒ–
        const normalizedSource = translator.normalizeLanguageCode(sourceLang);
        const normalizedTarget = translator.normalizeLanguageCode(targetLang);
        
        currentTranslationPair = {
            source: sourceLang,
            target: targetLang,
            normalizedSource: normalizedSource,
            normalizedTarget: normalizedTarget
        };
        
        // è¨€èªåã‚’å–å¾—
        const targetLangName = transSelect.options[transSelect.selectedIndex].text;
        
        // ç¿»è¨³å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
        Translator.availability({
            sourceLanguage: normalizedSource,
            targetLanguage: normalizedTarget
        }).then(availability => {
            console.log(`Estado del modelo de traducciÃ³n ${transNum}: ${sourceLang} â†’ ${targetLang} = ${availability}`);
            
            if (availability === 'downloadable') {
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªå ´åˆ
                console.log(`Modelo para traducciÃ³n ${transNum} descargable: ${targetLangName}`);
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¸¡ã•ã‚Œã¦ã„ã‚Œã°ï¼ˆç¿»è¨³è¨€èªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚ï¼‰è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const isDirectUserGesture = event && (event.type === 'change');
                
                if (isDirectUserGesture) {
                    // ç¿»è¨³è¨€èªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´ã«ã‚ˆã‚‹ç›´æ¥çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
                    console.log(`Iniciando descarga automÃ¡tica de modelo para traducciÃ³n ${transNum} (cambio en menÃº desplegable): ${targetLangName}`);
                    
                    // pendingModelsã‹ã‚‰è©²å½“ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤
                    pendingModels = pendingModels.filter(m => 
                        !(m.sourceLang === normalizedSource && 
                          m.targetLang === normalizedTarget)
                    );
                    updateQueueStatus();
                    
                    translator.preloadLanguagePack(normalizedSource, normalizedTarget).then(() => {
                        console.log(`Descarga de modelo para traducciÃ³n ${transNum} completada: ${targetLangName}`);
                        
                        // pendingModelsã«æ®‹ã‚ŠãŒã‚ã‚‹ã‹ç¢ºèª
                        if (pendingModels.length > 0) {
                            // æ®‹ã‚ŠãŒã‚ã‚‹å ´åˆã¯æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã®ãƒœã‚¿ãƒ³ã‚’Mostrar
                            const nextModel = pendingModels[0];
                            if (modelArea && modelBtn) {
                                modelArea.style.display = 'block';
                                modelBtn.style.display = 'inline-block';
                                modelBtn.disabled = false;
                                modelBtn.style.background = '#ff6b6b';
                                modelBtn.innerHTML = `ğŸ“¥ Descargar modelo ${nextModel.langName}`;
                                modelStatus.textContent = `âœ… ${targetLangName}Â¡completado!`;
                                modelStatus.style.color = '#4CAF50';
                                
                                // currentTranslationPairã‚’æ›´æ–°
                                currentTranslationPair = {
                                    source: nextModel.sourceLang,
                                    target: nextModel.targetLang,
                                    normalizedSource: nextModel.sourceLang,
                                    normalizedTarget: nextModel.targetLang
                                };
                            }
                        } else {
                            // å…¨ã¦å®Œäº†ã—ãŸå ´åˆã®ã¿ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’éMostrarã«
                            if (transNum === 1 && modelArea) {
                                modelArea.style.display = 'none';
                            }
                        }
                    }).catch(error => {
                        console.error(`Error al descargar modelo para traducciÃ³n ${transNum}:`, error);
                        
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç¿»è¨³1ã®å ´åˆã®ã¿ãƒœã‚¿ãƒ³ã‚’Mostrar
                        if (transNum === 1 && modelArea) {
                            modelArea.style.display = 'block';
                            modelBtn.style.display = 'inline-block';
                            modelBtn.disabled = false;
                            modelBtn.style.background = '#ff6b6b';
                            modelBtn.innerHTML = `ğŸ“¥ Descargar modelo ${targetLangName}`;
                            modelStatus.textContent = 'Error: Descarga manualmente por favor';
                            modelStatus.style.color = '#f44336';
                        }
                    });
                } else {
                    // éŸ³å£°èªè­˜è¨€èªå¤‰æ›´ã«ã‚ˆã‚‹é–“æ¥çš„ãªå‘¼ã³å‡ºã—
                    console.log(`Modelo para traducciÃ³n ${transNum} requiere descarga manual (cambio de idioma de reconocimiento de voz): ${targetLangName}`);
                    
                    // é‡è¤‡ã‚’é¿ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾…ã¡ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    const exists = pendingModels.some(m => 
                        m.sourceLang === normalizedSource && 
                        m.targetLang === normalizedTarget
                    );
                    
                    if (!exists) {
                        pendingModels.push({
                            transNum: transNum,
                            sourceLang: normalizedSource,
                            targetLang: normalizedTarget,
                            langName: targetLangName
                        });
                        updateQueueStatus(); // ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°
                    }
                    
                    // pendingModelsã«ä½•ã‹ã‚ã‚‹å ´åˆã¯æœ€åˆã®ãƒ¢ãƒ‡ãƒ«ã®ãƒœã‚¿ãƒ³ã‚’Mostrar
                    if (pendingModels.length > 0 && modelArea && modelBtn) {
                        const firstModel = pendingModels[0];
                        modelArea.style.display = 'block';
                        modelBtn.style.display = 'inline-block';
                        modelBtn.disabled = false; // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                        modelBtn.style.background = '#ff6b6b'; // èƒŒæ™¯è‰²ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆèµ¤ï¼‰
                        modelBtn.innerHTML = `ğŸ“¥ Descargar modelo ${firstModel.langName}`;
                        modelStatus.textContent = 'Se requiere descarga manual despuÃ©s de cambiar el idioma de reconocimiento de voz';
                        modelStatus.style.color = '#333'; // ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚‚ãƒªã‚»ãƒƒãƒˆ
                        
                        // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã§æœ€åˆã®ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        currentTranslationPair = {
                            source: sourceLang,
                            target: targetLang,
                            normalizedSource: normalizedSource,
                            normalizedTarget: normalizedTarget
                        };
                    } else if (pendingModels.length > 1 && transNum === 1 && modelArea) {
                        // è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«ãŒå¾…æ©Ÿä¸­ã®å ´åˆã¯æ¡ˆå†…ã‚’Mostrar
                        modelStatus.textContent = `Otros ${pendingModels.length - 1} modelos esperando descarga`;
                    }
                }
            } else if (availability === 'available') {
                // æ—¢ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿
                console.log(`Modelo para traducciÃ³n ${transNum} ya descargado: ${targetLangName}`);
                // ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã§pendingModelsãŒç©ºã®å ´åˆã®ã¿ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’éMostrar
                if (pendingModels.length === 0 && modelArea) {
                    modelArea.style.display = 'none';
                }
            } else {
                // åˆ©ç”¨ä¸å¯
                console.log(`Modelo para traducciÃ³n ${transNum} no disponible: ${targetLangName} (${availability})`);
                // ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç”¨ä¸å¯ã§pendingModelsãŒç©ºã®å ´åˆã®ã¿ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’éMostrar
                if (pendingModels.length === 0 && modelArea) {
                    modelArea.style.display = 'none';
                }
            }
        }).catch(error => {
            console.error('Error al verificar disponibilidad de traducciÃ³n:', error);
        });
    }
    
    function preloadTranslationModel() {
        // pendingModelsã‹ã‚‰æœ€åˆã®ãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—ã™ã‚‹ã‹ã€currentTranslationPairã‚’ä½¿ç”¨
        let modelToDownload = null;
        
        if (pendingModels.length > 0) {
            modelToDownload = pendingModels[0];
        } else if (currentTranslationPair) {
            modelToDownload = {
                sourceLang: currentTranslationPair.normalizedSource,
                targetLang: currentTranslationPair.normalizedTarget,
                langName: currentTranslationPair.targetLangName || 'Idioma de traducciÃ³n'
            };
        }
        
        if (!modelToDownload) return;
        
        const modelBtn = document.getElementById('preloadModelBtn');
        const modelStatus = document.getElementById('modelStatusText');
        
        // iframeå†…ã®chromeTranslatorã‚’å–å¾—
        const iframe = document.getElementById('asr_frame');
        if (!iframe || !iframe.contentWindow || !iframe.contentWindow.chromeTranslator) {
            alert('Chrome Translator no preparado. Por favor, recarga la pÃ¡gina.');
            return;
        }
        
        const translator = iframe.contentWindow.chromeTranslator;
        
        // ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‹ã‚‰è¨€èªåã‚’å–å¾—
        const targetLangName = modelToDownload.langName;
        
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        modelBtn.disabled = true;
        modelBtn.innerHTML = `ğŸ“¥ Preparando descarga de ${targetLangName}...`;
        modelStatus.textContent = '';
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€²æ—ã‚’ç›£è¦–
        translator.onDownloadStatusChange = (status) => {
            if (status.status === 'downloading' && status.progress !== undefined) {
                modelBtn.innerHTML = `â³ Descargando ${targetLangName}... ${status.progress}%`;
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼Mostrarï¼ˆãƒœã‚¿ãƒ³ã®èƒŒæ™¯ã¨ã—ã¦ï¼‰
                modelBtn.style.background = `linear-gradient(90deg, #4CAF50 ${status.progress}%, #ff6b6b ${status.progress}%)`;
            }
        };
        
        // äº‹å‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
        translator.preloadLanguagePack(modelToDownload.sourceLang, modelToDownload.targetLang).then(result => {
            if (result) {
                // å®Œäº†ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                if (pendingModels.length > 0) {
                    pendingModels = pendingModels.filter(m => 
                        !(m.sourceLang === modelToDownload.sourceLang && 
                          m.targetLang === modelToDownload.targetLang)
                    );
                    updateQueueStatus(); // ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°
                }
                
                // æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚‹å ´åˆ
                if (pendingModels.length > 0) {
                    const nextModel = pendingModels[0];
                    modelBtn.disabled = false;
                    modelBtn.style.background = '#ff6b6b';
                    modelBtn.innerHTML = `ğŸ“¥ Descargar modelo ${nextModel.langName}`;
                    modelStatus.textContent = `âœ… ${targetLangName}Â¡completado!`;
                    modelStatus.style.color = '#4CAF50';
                    
                    // æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ç”¨ã«currentTranslationPairã‚’æ›´æ–°
                    currentTranslationPair = {
                        normalizedSource: nextModel.sourceLang,
                        normalizedTarget: nextModel.targetLang,
                        targetLangName: nextModel.langName
                    };
                } else {
                    // å…¨ã¦å®Œäº†
                    modelBtn.style.display = 'none';
                    modelStatus.textContent = 'âœ… Â¡Descarga de todos los modelos completada!';
                    modelStatus.style.color = '#4CAF50';
                    setTimeout(() => {
                        const modelArea = document.getElementById('modelDownloadArea');
                        if (modelArea) modelArea.style.display = 'none';
                    }, 3000);
                    currentTranslationPair = null;
                }
            } else {
                modelBtn.disabled = false;
                modelBtn.style.background = '#ff6b6b';
                modelBtn.innerHTML = `ğŸ“¥ Descargar modelo ${targetLangName}`;
                modelStatus.textContent = 'âŒ Error en la descarga';
                modelStatus.style.color = '#f44336';
            }
        }).catch(error => {
            console.error('Error en precarga:', error);
            modelBtn.disabled = false;
            modelBtn.style.background = '#ff6b6b';
            modelBtn.innerHTML = `ğŸ“¥ Descargar modelo ${targetLangName}`;
            modelStatus.textContent = 'âŒ Error: ' + error.message;
            modelStatus.style.color = '#f44336';
        });
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸãƒã‚§ãƒƒã‚¯
    setTimeout(() => {
        checkTranslationModel();
    }, 2000);
</script>

</html>
